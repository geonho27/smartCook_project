{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ recipe.title }} ë ˆì‹œí”¼</title>
  <link rel="stylesheet" href="{% static 'css/upload.css' %}">
  <style>
  .listening-popup {
    display: none;
    position: fixed; /* âœ… í•­ìƒ í™”ë©´ ì¤‘ì•™ */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(197, 197, 197, 0.9);
    color: #fff;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
    width: 250px;
  }
  .listening-icon {
    font-size: 48px;
    animation: pulse 1s infinite;
  }
  .close-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    font-size: 18px;
    color: #fff;
    cursor: pointer;
  }
  .close-btn:hover {
    color: #ff5c5c;
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.6; }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -40%); }
    to   { opacity: 1; transform: translate(-50%, -50%); }
  }
  </style>
</head>
<body class="upload">
  <div class="main-navbar">
    <div class="main-nav-left">
      <a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a>
    </div>
    <div class="main-nav-right">
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-button">Logout</button>
      </form>
    </div>
  </div>
  
  <div class="recipe-container">
    <div class="recipe-content">
      <div class="recipe-left-box">
        <h2>ìƒì„¸ ë ˆì‹œí”¼</h2>
        <div class="recipe-subheading"><strong>ğŸ¥¢ {{ recipe.title }} ë ˆì‹œí”¼</strong></div>
        <p><strong>ì¬ë£Œ</strong></p>
        <ul>
          {% for ing in recipe.ingredients %}
            <li>{{ ing }}</li>
          {% endfor %}
        </ul>
        <p><strong>ë§Œë“œëŠ” ë²•</strong></p>
        <ol>
          {% for step in recipe.steps %}
            <li>{{ step }}</li>
          {% endfor %}
        </ol>
      </div>
      <div class="recipe-right-box">
        <h2>ìœ íŠœë¸Œ ì˜ìƒ ë³´ëŸ¬ê°€ê¸°</h2>
        <div class="youtube-videos">
          {% for video in videos %}
            <div class="video-card">
              <a href="{{ video.url }}" target="_blank">
                <img src="{{ video.thumbnail }}" alt="{{ video.title }}">
                <p>{{ video.title }}</p>
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- ë²„íŠ¼ -->
  <div class="recipe-bottom-button">
    {% if mode == "detected" %}
      <button onclick="readRecipe()" class="tts-button" style="margin-right: 10px;">ğŸ”Š ë ˆì‹œí”¼ ì½ì–´ì£¼ê¸°</button>
      <button onclick="openSTTPopup()" class="tts-button" style="margin-right: 10px;">ğŸ¤ ìŒì„±ìœ¼ë¡œ ëª…ë ¹í•˜ê¸°</button>
      <button onclick="location.href='{% url 'search_recipes_by_detected' %}?sort=match'">
        ë‹¤ë¥¸ ë ˆì‹œí”¼ ë³´ëŸ¬ê°€ê¸°
      </button>
    {% else %}
      <button onclick="readRecipe()" class="tts-button" style="margin-right: 10px;">ğŸ”Š ë ˆì‹œí”¼ ì½ì–´ì£¼ê¸°</button>
      <button onclick="openSTTPopup()" class="tts-button" style="margin-right: 10px;">ğŸ¤ ìŒì„±ìœ¼ë¡œ ëª…ë ¹í•˜ê¸°</button>
      <button onclick="location.href='{% url 'food_upload' %}?q={{ query }}'">
        ë‹¤ë¥¸ ë ˆì‹œí”¼ ë³´ëŸ¬ê°€ê¸°
      </button>
    {% endif %}
  </div>

  <div class="feedback-footer">
    Â© SmartCook. All rights reserved.
  </div>
</body>
</html>

<!-- íŒì—… -->
<div id="listening-popup" class="listening-popup" onclick="handlePopupClick(event)">
  <button class="close-btn" onclick="stopListening(true)">âœ•</button>
  <div class="listening-icon">ğŸ¤</div>
  <p id="listening-text">ëˆŒëŸ¬ì„œ ìŒì„± ì¸ì‹ ì‹œì‘</p>
</div>

<script>
   function readRecipe() {
    const title = "{{ recipe.title|escapejs }}";
    const steps = [{% for step in recipe.steps %}"{{ step|escapejs }}",{% endfor %}];
    let text = `${title} ë ˆì‹œí”¼ì…ë‹ˆë‹¤. `;
    text += "ì¡°ë¦¬ ë°©ë²•ì€ ";
    steps.forEach((step, i) => { text += `${i + 1}ë‹¨ê³„, ${step}. `; });

    const voice = "{{ user.voice_name|default:'ko-KR-Chirp3-HD-Charon' }}";
    const ttsUrl = `/tts/?text=${encodeURIComponent(text)}&voice=${encodeURIComponent(voice)}`;
    new Audio(ttsUrl).play();
  }

  const recipeTitle = "{{ recipe.title|escapejs }}";
  const steps = [{% for step in recipe.steps %}"{{ step|escapejs }}",{% endfor %}];
  let currentStep = 0;
  let mediaRecorder;
  let isListening = false;

  function speak(text) {
    const voice = "{{ user.voice_name|default:'ko-KR-Chirp3-HD-Charon' }}";
    const ttsUrl = `/tts/?text=${encodeURIComponent(text)}&voice=${encodeURIComponent(voice)}`;
    new Audio(ttsUrl).play();
  }

  function showListeningPopup() {
    document.getElementById("listening-popup").style.display = "block";
    document.getElementById("listening-text").textContent = "ğŸ¤ ëˆŒëŸ¬ì„œ ìŒì„± ì¸ì‹ ì‹œì‘";
  }
  function hideListeningPopup() {
    document.getElementById("listening-popup").style.display = "none";
  }

  function openSTTPopup() {
    showListeningPopup();
    console.log("ğŸ¤ [STT] íŒì—… ì—´ë¦¼ - ëŒ€ê¸° ìƒíƒœ");
  }

  function handlePopupClick(event) {
    if (event.target.classList.contains("close-btn")) return;
    startSTTOnce();
  }

  async function startSTTOnce() {
    if (isListening) return;
    isListening = true;
    document.getElementById("listening-text").textContent = "ğŸ™ï¸ ì¸ì‹ ì¤‘...";

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });

      mediaRecorder.ondataavailable = async (event) => {
        if (event.data && event.data.size > 0) {
          const formData = new FormData();
          formData.append("audio", event.data, "input.webm");

          try {
            const response = await fetch("/stt/", { method: "POST", body: formData });
            const data = await response.json();
            console.log("âœ… [STT ê²°ê³¼]:", data.text);
            handleCommand(data.text);
          } catch (err) {
            console.error("âŒ [STT ìš”ì²­ ì‹¤íŒ¨]:", err);
          } finally {
            resetToIdle(); // íŒì—… ë‹«ì§€ ì•Šê³  ë‹¤ì‹œ ëŒ€ê¸°
          }
        }
      };

      mediaRecorder.start();
      console.log("ğŸ™ï¸ [STT] MediaRecorder ì‹œì‘ë¨");

      setTimeout(() => { if (isListening) mediaRecorder.stop(); }, 3000);

    } catch (err) {
      console.error("âŒ [STT ì˜¤ë¥˜]:", err);
      resetToIdle();
    }
  }

  function resetToIdle() {
    isListening = false;
    document.getElementById("listening-text").textContent = "ğŸ¤ ëˆŒëŸ¬ì„œ ìŒì„± ì¸ì‹ ì‹œì‘";
    console.log("ğŸ”„ [STT] ëŒ€ê¸° ìƒíƒœë¡œ ë³µê·€");
  }

  function stopListening(closePopup = false) {
    isListening = false;
    if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
    if (closePopup) hideListeningPopup();
    else resetToIdle();
    console.log("ğŸ›‘ [STT] ì¢…ë£Œë¨");
  }

  function handleCommand(command) {
    command = command.replace(/\s+/g, "").trim();
    console.log("handleCommand ì…ë ¥ê°’:", command);

    switch(command) {
      case "ìš”ë¦¬ì‹œì‘":
        currentStep = 0;
        speak(`${recipeTitle} ë ˆì‹œí”¼ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì²« ë‹¨ê³„ì…ë‹ˆë‹¤. ${steps[currentStep]}`);
        break;
      case "ë‹¤ìŒ":
        if (currentStep < steps.length - 1) {
          currentStep++;
          speak("ë‹¤ìŒ ë‹¨ê³„ì…ë‹ˆë‹¤. " + steps[currentStep]);
        } else speak("ì´ë¯¸ ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤.");
        break;
      case "ì´ì „":
        if (currentStep > 0) {
          currentStep--;
          speak("ì´ì „ ë‹¨ê³„ì…ë‹ˆë‹¤. " + steps[currentStep]);
        } else speak("í˜„ì¬ê°€ ì²« ë²ˆì§¸ ë‹¨ê³„ì…ë‹ˆë‹¤.");
        break;
      case "ë‹¤ì‹œ":
        speak("í˜„ì¬ ë‹¨ê³„ì…ë‹ˆë‹¤. " + steps[currentStep]);
        break;
      case "ì¢…ë£Œ":
      case "ë":
      case "ê·¸ë§Œ":
        speak("ë ˆì‹œí”¼ ì•ˆë‚´ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. ìš”ë¦¬ë¥¼ ë§›ìˆê²Œ ì™„ì„±í•´ë³´ì„¸ìš”!");
        stopListening(true); // íŒì—… ë‹«ê¸°
        currentStep = 0;
        break;
      case "ë§ˆì§€ë§‰":
      case "ìŠ¤í‚µ":
        currentStep = steps.length - 1;
        speak("ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤. " + steps[currentStep]);
        break;
      default:
        console.log("ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹:", command);
        break;
    }
  }
</script>
