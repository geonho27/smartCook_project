{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartCook - ì‹¤ì‹œê°„ YOLO</title>
  <link rel="stylesheet" href="{% static 'css/upload.css' %}" />
  <style>
    /* ì›¹ì—ì„œ ë” í° ì¹´ë©”ë¼ ì˜ì—­ */
    @media (min-width: 769px) {
      .upload-form-box {
        max-width: 1200px !important;
      }
      .camera-wrapper {
        padding-top: 45% !important; /* 16:9ë³´ë‹¤ ë” ë„“ê²Œ */
      }
    }
    
    /* ëª¨ë°”ì¼ì—ì„œëŠ” ê¸°ì¡´ í¬ê¸° ìœ ì§€ */
    @media (max-width: 768px) {
      .upload-form-box {
        max-width: 480px !important;
      }
      .camera-wrapper {
        padding-top: 56.25% !important; /* 16:9 ë¹„ìœ¨ ìœ ì§€ */
      }
    }
    
    /* ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .camera-controls button:hover {
      background: rgba(255,255,255,0.3) !important;
    }
  </style>
</head>

<body>
  <main>
    <div class="main-navbar">
      <!-- ì™¼ìª½ -->
      <div class="main-nav-left">
        <a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a>
      </div>
    
      <!-- ì˜¤ë¥¸ìª½ -->
      <div class="main-nav-right">
        <form method="POST" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="logout-button">Logout</button>
        </form>
      </div>
    </div>

    <!-- íƒìƒ‰ ë°©ì‹ ë²„íŠ¼ -->
    <div class="btn-group">
      <a href="{% url 'food_upload' %}" class="btn">ìŒì‹ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</a>
      <a href="{% url 'upload' %}" class="btn">ì¬ë£Œë¡œ íƒìƒ‰í•˜ê¸°</a>
      <button class="btn active-btn">ì‹¤ì‹œê°„ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</button>
    </div>
    
    <div class="upload-container">
      <div class="upload-form-box" style="position: relative; width: 100%; max-width: 1200px; margin: 0 auto;">
        <h2 class="upload-title" style="text-align: center;">ì‹¤ì‹œê°„ YOLO</h2>
        <div class="camera-wrapper" style="position: relative; padding-top: 56.25%; /* 16:9 ë¹„ìœ¨ ìœ ì§€ */ border-radius: 12px; overflow: hidden; background: #f7f4f0; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
          <video id="video" autoplay playsinline muted 
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"></video>
          <img id="detected" alt="ì‹¤ì‹œê°„ ê°ì§€ ì´ë¯¸ì§€" 
               style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
          
          <!-- ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
          <div class="camera-controls" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px; display: flex; gap: 10px; z-index: 1000;">
            <button id="switch-camera" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              ğŸ“· ì „ë©´/í›„ë©´
            </button>
            <button id="stop-camera" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              â¹ï¸ ì¢…ë£Œ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ -->
    <section class="recognized" id="ingredient-buttons" style="display:none;">
      <h4 class="recognized-title">ì¸ì‹ëœ ì¬ë£Œ</h4>
      <div class="chip-box" id="recognized-list">
        <!-- ë™ì ìœ¼ë¡œ ì¸ì‹ëœ ì¬ë£Œë“¤ì´ ì¶”ê°€ë¨ -->
      </div>
      <div class="confirm-wrapper">
        <button type="button" id="toRecipeBtn" class="confirm-btn">ì„ íƒ ì™„ë£Œ</button>
      </div>
    </section>

    <!-- ë ˆì‹œí”¼ ì¶”ì²œ ê²°ê³¼ ì„¹ì…˜ -->
    <section class="recommend" id="recipe-section" style="display:none;">
      <div class="result-header">
        <p id="recipe-header-text">ì¸ì‹ëœ ì¬ë£Œì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼</p>
      </div>
      <div class="recipe-list" id="recipe-list">
        <!-- ë™ì ìœ¼ë¡œ ë ˆì‹œí”¼ë“¤ì´ ì¶”ê°€ë¨ -->
      </div>
    </section>

<script>
  const video = document.getElementById('video');
  const detected = document.getElementById('detected');
  const switchCameraBtn = document.getElementById('switch-camera');
  const stopCameraBtn = document.getElementById('stop-camera');
  const ingredientButtons = document.getElementById('ingredient-buttons');
  const recognizedList = document.getElementById('recognized-list');
  const toRecipeBtn = document.getElementById('toRecipeBtn');
  const recipeSection = document.getElementById('recipe-section');
  const recipeList = document.getElementById('recipe-list');
  const recipeHeaderText = document.getElementById('recipe-header-text');
  
  let websocket = null;
  let isStreaming = false;
  let currentFacingMode = 'environment'; // ê¸°ë³¸ê°’: í›„ë©´ ì¹´ë©”ë¼
  let detectedIngredients = new Set(); // ì¸ì‹ëœ ì¬ë£Œë“¤ì„ ì €ì¥

  // ì›¹ì†Œì¼“ ì—°ê²°
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/detect/`;
    
    websocket = new WebSocket(wsUrl);
    
    websocket.onopen = function(event) {
      console.log('ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ');
      startCamera();
    };
    
    websocket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if (data.image) {
        detected.src = data.image;
      }
      
      // ì¸ì‹ëœ ì¬ë£Œë“¤ ì²˜ë¦¬
      if (data.detections && data.detections.length > 0) {
        updateDetectedIngredients(data.detections);
      }
      
      // ìµœì¢… ì¸ì‹ ê²°ê³¼ ì²˜ë¦¬
      if (data.final_detections && data.final_detections.length > 0) {
        showIngredientSection(data.final_detections);
      }
    };
    
    websocket.onclose = function(event) {
      console.log('ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œ');
      stopCamera();
      // ì›¹ì†Œì¼“ ì¢…ë£Œ ì‹œì—ëŠ” UIë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€ (ì‚¬ìš©ìê°€ ì¢…ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œê¹Œì§€)
    };
    
    websocket.onerror = function(error) {
      console.error('ì›¹ì†Œì¼“ ì˜¤ë¥˜:', error);
      alert('ì‹¤ì‹œê°„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    };
  }

  // ì¹´ë©”ë¼ ì‹œì‘
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: currentFacingMode,  // í˜„ì¬ ì„¤ì •ëœ ì¹´ë©”ë¼ ëª¨ë“œ
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      });
      video.srcObject = stream;
      isStreaming = true;
      
      // í”„ë ˆì„ ì „ì†¡ ì‹œì‘
      sendFrames();
    } catch (err) {
      console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', err);
      alert('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
    }
  }

  // ì¹´ë©”ë¼ ì •ì§€
  function stopCamera() {
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
    isStreaming = false;
  }

  // í”„ë ˆì„ ì „ì†¡
  function sendFrames() {
    if (!isStreaming || !websocket || websocket.readyState !== WebSocket.OPEN) {
      return;
    }

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // ìº”ë²„ìŠ¤ë¥¼ base64ë¡œ ë³€í™˜
      const imageData = canvas.toDataURL('image/jpeg', 0.8);
      
      // ì›¹ì†Œì¼“ìœ¼ë¡œ í”„ë ˆì„ ì „ì†¡
      websocket.send(JSON.stringify({
        frame: imageData
      }));
    }

    // 100msë§ˆë‹¤ í”„ë ˆì„ ì „ì†¡ (10fps)
    setTimeout(sendFrames, 100);
  }

  // ì¸ì‹ëœ ì¬ë£Œ ì—…ë°ì´íŠ¸
  function updateDetectedIngredients(detections) {
    detections.forEach(detection => {
      const ingredient = detection.split(' ')[0]; // "ì‚¬ê³¼ 0.85" -> "ì‚¬ê³¼"
      if (ingredient && ingredient !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        detectedIngredients.add(ingredient);
      }
    });
  }

  // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ
  function showIngredientSection(finalDetections) {
    // ìµœì¢… ì¸ì‹ ê²°ê³¼ë¥¼ Setì— ì¶”ê°€
    finalDetections.forEach(ingredient => {
      if (ingredient && ingredient !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        detectedIngredients.add(ingredient);
      }
    });

    // ì¸ì‹ëœ ì¬ë£Œê°€ ìˆìœ¼ë©´ ì„¹ì…˜ í‘œì‹œ
    if (detectedIngredients.size > 0) {
      renderIngredientChips(Array.from(detectedIngredients));
      ingredientButtons.style.display = 'block';
      ingredientButtons.scrollIntoView({ behavior: 'smooth' });
    }
  }

  // ì¬ë£Œ ì¹© ë Œë”ë§
  function renderIngredientChips(ingredients) {
    recognizedList.innerHTML = '';
    ingredients.forEach(ingredient => {
      const label = document.createElement('label');
      label.className = 'chip';
      label.innerHTML = `
        <input type="checkbox" class="chip-radio" name="q" value="${escapeHtml(ingredient)}" checked>
        ${escapeHtml(ingredient)}
      `;
      recognizedList.appendChild(label);
    });
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ë ˆì‹œí”¼ ì¶”ì²œ ìš”ì²­ (JSON API ì‚¬ìš©)
  async function getRecipeRecommendations(selectedIngredients) {
    try {
      const query = selectedIngredients.map(q => `q=${encodeURIComponent(q)}`).join('&');
      const response = await fetch(`/api/recipes/?${query}&sort=match`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.has_recipes) {
        return [];
      }
      
      // JSON ë°ì´í„°ë¥¼ ë ˆì‹œí”¼ ê°ì²´ë¡œ ë³€í™˜
      const recipes = data.recipes.map(recipe => ({
        title: recipe.title || '',
        image: recipe.image || '',
        ingredients: recipe.ingredients || [],
        id: recipe.id || ''
      }));
      
      return recipes;
    } catch (error) {
      console.error('ë ˆì‹œí”¼ ì¶”ì²œ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ë ˆì‹œí”¼ ê²°ê³¼ ë Œë”ë§
  function renderRecipes(recipes) {
    recipeList.innerHTML = '';
    
    if (recipes.length === 0) {
      recipeList.innerHTML = '<div class="no-result"><p>ì¸ì‹ëœ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      return;
    }

    recipes.forEach(recipe => {
      const recipeCard = document.createElement('div');
      recipeCard.className = 'recipe-card';
      recipeCard.innerHTML = `
        <img src="${escapeHtml(recipe.image)}" alt="${escapeHtml(recipe.title)}" onerror="this.src='/static/images/recipe/muk.png'">
        <h5>${escapeHtml(recipe.title)}</h5>
        <h6 style="text-align: center;">ì¬ë£Œ</h6>
        <ul style="list-style-type: none; padding-left: 0;">
          ${recipe.ingredients.map(ing => `<li>${escapeHtml(ing)}</li>`).join('')}
        </ul>
        <a href="/recipes/${recipe.id}/" class="btn-category-done">
          ìš”ë¦¬í•˜ëŸ¬ ê°€ê¸°
        </a>
      `;
      recipeList.appendChild(recipeCard);
    });
  }


  // ì¹´ë©”ë¼ ì „í™˜ í•¨ìˆ˜
  async function switchCamera() {
    // í˜„ì¬ ì¹´ë©”ë¼ ëª¨ë“œ ë³€ê²½
    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    switchCameraBtn.textContent = currentFacingMode === 'environment' ? 'ğŸ“· ì „ë©´/í›„ë©´' : 'ğŸ“· í›„ë©´/ì „ë©´';
    
    // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì •ì§€
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
    }
    
    // ìƒˆ ì¹´ë©”ë¼ë¡œ ì‹œì‘
    await startCamera();
  }

  // ì¹´ë©”ë¼ ì¢…ë£Œ í•¨ìˆ˜
  function stopCameraStream() {
    console.log('ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ë¨');
    
    stopCamera();
    if (websocket) {
      websocket.close();
    }
    
    // ì¸ì‹ëœ ì¬ë£Œê°€ ìˆìœ¼ë©´ ì„¹ì…˜ í‘œì‹œ
    if (detectedIngredients.size > 0) {
      console.log('ì¸ì‹ëœ ì¬ë£Œ ê°œìˆ˜:', detectedIngredients.size);
      
      // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ
      const ingredientSection = document.getElementById('ingredient-buttons');
      if (ingredientSection) {
        ingredientSection.style.display = 'block';
        console.log('ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ');
        
        // ì¬ë£Œ ì¹© ë Œë”ë§
        renderIngredientChips(Array.from(detectedIngredients));
        
        // ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        ingredientSection.scrollIntoView({ behavior: 'smooth' });
      }
    } else {
      console.log('ì¸ì‹ëœ ì¬ë£Œê°€ ì—†ìŒ');
      alert('ì¸ì‹ëœ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  switchCameraBtn.addEventListener('click', switchCamera);
  stopCameraBtn.addEventListener('click', stopCameraStream);
  
  // ì„ íƒ ì™„ë£Œ ë²„íŠ¼ ì´ë²¤íŠ¸
  toRecipeBtn.addEventListener('click', async function() {
    const selectedIngredients = Array.from(document.querySelectorAll('#recognized-list input:checked'))
      .map(el => el.value)
      .filter(Boolean);

    if (selectedIngredients.length === 0) {
      alert('ì¬ë£Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      return;
    }

    try {
      // ë¡œë”© í‘œì‹œ
      toRecipeBtn.textContent = 'ë ˆì‹œí”¼ ì°¾ëŠ” ì¤‘...';
      toRecipeBtn.disabled = true;

      // ë ˆì‹œí”¼ ì¶”ì²œ ìš”ì²­
      const recipes = await getRecipeRecommendations(selectedIngredients);
      
      // í—¤ë” í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      recipeHeaderText.textContent = `${selectedIngredients.join(', ')}ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ (${recipes.length}ê°œ)`;
      
      // ë ˆì‹œí”¼ ê²°ê³¼ ë Œë”ë§
      renderRecipes(recipes);
      
      // ë ˆì‹œí”¼ ì„¹ì…˜ í‘œì‹œ
      recipeSection.style.display = 'block';
      recipeSection.scrollIntoView({ behavior: 'smooth' });
      
      // ì„±ê³µ ë©”ì‹œì§€
      if (recipes.length > 0) {
        console.log(`${recipes.length}ê°œì˜ ë ˆì‹œí”¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
      } else {
        console.log('í•´ë‹¹ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
      
    } catch (error) {
      console.error('ë ˆì‹œí”¼ ì¶”ì²œ ì˜¤ë¥˜:', error);
      alert('ë ˆì‹œí”¼ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      
      // ì—ëŸ¬ ì‹œì—ë„ ë ˆì‹œí”¼ ì„¹ì…˜ì„ í‘œì‹œí•˜ì—¬ ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°± ì œê³µ
      recipeSection.style.display = 'block';
      recipeList.innerHTML = '<div class="no-result"><p>ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>';
    } finally {
      // ë²„íŠ¼ ìƒíƒœ ë³µì›
      toRecipeBtn.textContent = 'ì„ íƒ ì™„ë£Œ';
      toRecipeBtn.disabled = false;
    }
  });

  // ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼
  switchCameraBtn.addEventListener('mouseenter', function() {
    this.style.background = 'rgba(255,255,255,0.3)';
  });
  switchCameraBtn.addEventListener('mouseleave', function() {
    this.style.background = 'rgba(255,255,255,0.2)';
  });

  stopCameraBtn.addEventListener('mouseenter', function() {
    this.style.background = 'rgba(255,255,255,0.3)';
  });
  stopCameraBtn.addEventListener('mouseleave', function() {
    this.style.background = 'rgba(255,255,255,0.2)';
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›¹ì†Œì¼“ ì—°ê²°
  document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
  });

  // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
  window.addEventListener('beforeunload', function() {
    if (websocket) {
      websocket.close();
    }
    stopCamera();
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œì—ëŠ” ìë™ìœ¼ë¡œ ëª¨ë“  ê²ƒì´ ì´ˆê¸°í™”ë¨
  });
</script>



    <!-- ì‹¤ì‹œê°„ íƒìƒ‰ì—ì„œëŠ” ì„ í˜¸ë„ ì„ íƒ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ -->

    <!-- ì‹¤ì‹œê°„ íƒìƒ‰ìš© ë ˆì‹œí”¼ ì„¹ì…˜ì€ JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->

    <!-- ì¶”ê°€ì¬ë£Œ ì„ íƒ ì„¹ì…˜ -->
    <section class="extra" id="extra-section" style="display:none;">
      <div class="extra-header">
        <h4 class="extra-title">ì¶”ê°€ ì¬ë£Œ ì„ íƒ</h4>
        <span class="small-text skip-extra" id="skip-extra-btn">
          ì¶”ê°€ ì¬ë£Œ ì—†ìŒ â†’
        </span>
      </div>

      <div class="chip-box" id="extra-ingredients"></div>

      <div class="cart-wrapper">
        <button class="cart-btns" id="go-cart-btn" style="margin-right: 10px;">ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™</button>
        <button class="cart-btns" id="go-detail-btn">ë ˆì‹œí”¼ ìƒì„¸ë³´ê¸°</button>
      </div>
    </section>
  </main>

  <div class="feedback-footer">
    Â© SmartCook. All rights reserved.
  </div>

  <!-- ì‹¤ì‹œê°„ íƒìƒ‰ìš© JavaScriptëŠ” ì¸ë¼ì¸ìœ¼ë¡œ êµ¬í˜„ë¨ -->
</body>
</html>
