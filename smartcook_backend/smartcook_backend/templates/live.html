{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMARTCOOK - ì‹¤ì‹œê°„ íƒìƒ‰</title>
  
  <link rel="stylesheet" href="{% static 'css/upload.css' %}" />
  <link rel="stylesheet" href="{% static 'css/resposive_ta_mo.css' %}" />
  <style>
    /* ì›¹ì—ì„œ ë” í° ì¹´ë©”ë¼ ì˜ì—­ */
    @media (min-width: 769px) {
      .upload-form-box {
        max-width: 1200px !important;
      }
      .camera-wrapper {
        padding-top: 45% !important; /* 16:9ë³´ë‹¤ ë” ë„“ê²Œ */
      }
    }
    
    /* ëª¨ë°”ì¼ì—ì„œëŠ” ê¸°ì¡´ í¬ê¸° ìœ ì§€ */
    @media (max-width: 768px) {
      .upload-form-box {
        max-width: 480px !important;
      }
      .camera-wrapper {
        padding-top: 56.25% !important; /* 16:9 ë¹„ìœ¨ ìœ ì§€ */
      }
    }
    
    /* ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .camera-controls button:hover {
      background: rgba(255,255,255,0.3) !important;
    }
    
    /* ëª¨ë°”ì¼ ë°˜ì‘í˜•ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ë°˜ì‘í˜•ì—ì„œ ì „ë©´/í›„ë©´ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
    @media (min-width: 481px) {
      #switch-camera {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <main>
    <div class="main-navbar">
      <div class="main-nav-left">
        <a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a>
      </div>
      
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    
      <div class="main-nav-right">
        <form method="POST" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="logout-button">Logout</button>
        </form>
      </div>
    </div>

    <div class="mobile-nav-menu" id="mobileNavMenu">
      <a href="{% url 'food_upload' %}">Recipe</a>
      <a href="{% url 'upload' %}">Picture</a>
      <a href="{% url 'live_page' %}">Realtime</a>
      <a href="{% url 'mainpage' %}">Home</a>
    </div>

    <div class="btn-group">
      <a href="{% url 'food_upload' %}" class="btn">ìŒì‹ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</a>
      <a href="{% url 'upload' %}" class="btn">ì¬ë£Œë¡œ íƒìƒ‰í•˜ê¸°</a>
      <button class="btn active-btn">ì‹¤ì‹œê°„ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</button>
    </div>
    
    <div id="promo-section" class="upload-container">
      <div class="upload-form-box" style="position: relative; width: 100%; max-width: 1200px; margin: 0 auto;">
        <h2 class="upload-title" style="text-align: center;">ì‹¤ì‹œê°„ ì¬ë£Œ ì¸ì‹</h2>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
          ì¹´ë©”ë¼ë¡œ ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ ë¹„ì¶”ë©´ AIê°€ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤
        </p>
        
        <div class="promo-video-wrapper" style="position: relative; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background: #f7f4f0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px;">
          <video autoplay muted loop playsinline
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
            <source src="{% static 'videos/realtime.mp4' %}" type="video/mp4">
            ì‹¤ì‹œê°„ ê°ì§€ ë°ëª¨ ì˜ìƒ
          </video>
          
          <div style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 20px; font-size: 14px;">
            ğŸ“¹ ì‹¤ì‹œê°„ ì¬ë£Œ ì¸ì‹ ë°ëª¨
          </div>
        </div>
        
        <div style="text-align: center;">
          <button id="start-detection-btn" class="start-btn" 
                  style="background: #76b5c5; color: white; border: none; padding: 18px 40px; border-radius: 25px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(118, 181, 197, 0.4); transition: all 0.3s ease;">
            ğŸš€ ì‹¤ì‹œê°„ íƒìƒ‰ ì‹œì‘í•˜ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- ëª¨ë°”ì¼ ì „ìš© í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ë°” (ì¹´ë©”ë¼ ë ˆì´ì–´ ì•„ë˜) -->
    <div id="mobile-camera-actions" style="display:none; position: fixed; left: 0; right: 0; bottom: 0; z-index: 1002;">
      <div style="max-width: 1200px; margin: 0 auto; padding: 10px 12px; display: flex; gap: 10px; justify-content: space-between;">
        <button id="mobile-return-home" style="flex:1; background:#ff6666; color:#fff; border:none; padding:14px 12px; border-radius:12px; font-weight:700;">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        <button id="mobile-fullscreen" style="flex:1; background:#444; color:#fff; border:none; padding:14px 12px; border-radius:12px; font-weight:700;">ğŸ” ì „ì²´í™”ë©´</button>
        <button id="mobile-stop" style="flex:1; background:#76b5c5; color:#fff; border:none; padding:14px 12px; border-radius:12px; font-weight:700;">âœ… ê°ì§€ ì™„ë£Œ</button>
      </div>
    </div>

    <div id="permission-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
      <div class="permission-box" style="background: white; padding: 40px 30px; border-radius: 20px; text-align: center; max-width: 400px; margin: 0 20px;">
        <h3 style="color: #76b5c5; margin-bottom: 20px; font-size: 24px;">ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”</h3>
        <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
          ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¸ì‹í•˜ê¸° ìœ„í•´<br>
          ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button id="allow-camera-btn" 
                  style="background: #76b5c5; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; flex: 1; max-width: 120px;">
            í—ˆìš© (Allow)
          </button>
          <button id="cancel-camera-btn" 
                  style="background: #ccc; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; flex: 1; max-width: 120px;">
            ì·¨ì†Œ (Cancel)
          </button>
        </div>
      </div>
    </div>

    <div id="camera-section" class="upload-container" style="display: none;">
      <div class="upload-form-box" style="position: relative; width: 100%; max-width: 1200px; margin: 0 auto;">
        <h2 class="upload-title" style="text-align: center;">ì‹¤ì‹œê°„ ì¬ë£Œ ê°ì§€ ì¤‘...</h2>
        
        <div class="camera-wrapper" style="position: relative; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background: #f7f4f0; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
          
          <video id="video" autoplay playsinline muted 
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"></video>
          
          <canvas id="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
          
          <div class="camera-controls" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px; display: flex; gap: 10px; z-index: 1000;">
            <button id="switch-camera" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              ğŸ“· ì „ë©´/í›„ë©´
            </button>
            <button id="stop-camera" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              âœ… ê°ì§€ ì™„ë£Œ
            </button>
            <button id="fullscreen-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              ğŸ” ì „ì²´í™”ë©´
            </button>
            <button id="return-home-btn" style="background: rgba(255,100,100,0.3); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              ğŸ  ì²˜ìŒìœ¼ë¡œ
            </button>
          </div>
          
          <div id="floating-ingredients" style="display: none; position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 15px; max-width: 320px; min-width: 280px; z-index: 10001; backdrop-filter: blur(10px); border: 2px solid rgba(118, 181, 197, 0.5);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
              <h4 style="color: #76b5c5; margin: 0; font-size: 18px;">ğŸ” ì¸ì‹ëœ ì¬ë£Œ</h4>
              <span id="selected-count" style="color: #76b5c5; font-size: 14px; background: rgba(118, 181, 197, 0.2); padding: 4px 8px; border-radius: 10px;">0ê°œ ì„ íƒ</span>
            </div>
            
            <div id="floating-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
              </div>
            
            <div style="text-align: center;">
              <button id="floating-complete-btn" style="background: #76b5c5; color: white; border: none; padding: 12px 25px; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(118, 181, 197, 0.4);">
                ğŸš€ ì„ íƒ ì™„ë£Œ (0ê°œ)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <section class="recognized" id="ingredient-buttons" style="display:none;">
      <h4 class="recognized-title">ì¸ì‹ëœ ì¬ë£Œ</h4>
      <div class="chip-box" id="recognized-list">
        </div>
      <div class="confirm-wrapper">
        <button type="button" id="toRecipeBtn" class="confirm-btn">ì„ íƒ ì™„ë£Œ</button>
      </div>
    </section>

    <section class="recommend" id="recipe-section" style="display:none;">
     <div class="result-header">
      <p id="recipe-header-text">ì¸ì‹ëœ ì¬ë£Œì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼</p>
      <div class="sort-options">
        <a href="#" id="sort-match" class="active">ê´€ë ¨ë„ ìˆœ</a>
        <a href="#" id="sort-ingredients">ì¬ë£Œ ì ì€ ìˆœ</a>
        </div>
      </div>

      <div class="recipe-list" id="recipe-list">

    <!-- ë™ì ìœ¼ë¡œ ë ˆì‹œí”¼ë“¤ì´ ì¶”ê°€ë¨ -->
      </div>

    <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€ -->
    <div class="pagination" id="pagination"></div>

    </section>

    
    <!-- âœ… ì¶”ê°€ì¬ë£Œ ì„ íƒ ì„¹ì…˜ -->
    <section class="extra" id="extra-section" style="display:none;">
      <div class="extra-header">
        <h4 class="extra-title">ì¶”ê°€ ì¬ë£Œ ì„ íƒ</h4>
        <span class="small-text skip-extra" id="skip-extra-btn">ì¶”ê°€ ì¬ë£Œ ì—†ìŒ â†’</span>
      </div>

      <div class="chip-box" id="extra-ingredients"></div>

      <div class="cart-wrapper">
        <button class="cart-btns" id="go-cart-btn" style="margin-right: 10px;">ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™</button>
        <button class="cart-btns" id="go-detail-btn">ë ˆì‹œí”¼ ìƒì„¸ë³´ê¸°</button>
      </div>
    </section>

  </main>

  <div class="feedback-footer">
    Â© SmartCook. All rights reserved.
  </div>
</body>
<script>
  function $(sel) { return document.querySelector(sel); }
  function $all(sel) { return Array.prototype.slice.call(document.querySelectorAll(sel)); }
  const extraSection = document.getElementById("extra-section");
  const extraIngredientsBox = document.getElementById("extra-ingredients");

  // ==========================================
  // ìº”ë²„ìŠ¤ ë° ë¹„ë””ì˜¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
  // ==========================================
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');

  // ... (ê¸°ì¡´ì˜ ë‹¤ë¥¸ UI ìš”ì†Œ ë³€ìˆ˜ ì„ ì–¸ì€ ë™ì¼) ...
  const switchCameraBtn = document.getElementById('switch-camera');
  const stopCameraBtn = document.getElementById('stop-camera');
  const ingredientButtons = document.getElementById('ingredient-buttons');
  const recognizedList = document.getElementById('recognized-list');
  const toRecipeBtn = document.getElementById('toRecipeBtn');
  const recipeSection = document.getElementById('recipe-section');
  const recipeList = document.getElementById('recipe-list');
  const recipeHeaderText = document.getElementById('recipe-header-text');
  const detected = document.getElementById('detected');
  let websocket = null;
  let isStreaming = false;
  let currentFacingMode = 'environment'; // ê¸°ë³¸ê°’: í›„ë©´ ì¹´ë©”ë¼
  let detectedIngredients = new Set();   // ì¸ì‹ëœ ì¬ë£Œë“¤ì„ ì €ì¥
  let currentSort = "match";             // ê¸°ë³¸ ì •ë ¬ ê¸°ì¤€ (ê´€ë ¨ë„ ìˆœ)
  let currentPage = 1;                   // í˜„ì¬ í˜ì´ì§€               






  // ìƒˆë¡œìš´ UI ìš”ì†Œë“¤

  const promoSection = document.getElementById('promo-section');
  const permissionModal = document.getElementById('permission-modal');
  const cameraSection = document.getElementById('camera-section');
  const startDetectionBtn = document.getElementById('start-detection-btn');
  const allowCameraBtn = document.getElementById('allow-camera-btn');
  const cancelCameraBtn = document.getElementById('cancel-camera-btn');
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const returnHomeBtn = document.getElementById('return-home-btn');
  
  const floatingIngredients = document.getElementById('floating-ingredients');
  const floatingList = document.getElementById('floating-list');
  const floatingCompleteBtn = document.getElementById('floating-complete-btn');
  const selectedCountSpan = document.getElementById('selected-count');
  
  let confirmedIngredients = new Set();
  let rejectedIngredients = new Set();
  let isFullscreenMode = false;
  let needsRecalculation = false;

  // ì›¹ì†Œì¼“ ì—°ê²°
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/detect/`;
    
    websocket = new WebSocket(wsUrl);
    
    websocket.onopen = function(event) {
      console.log('ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ');
      startCamera();
    };
    
    websocket.onmessage = function(event) {
      const data = JSON.parse(event.data);

      // ==========================================
      // â–¼â–¼â–¼â–¼â–¼ ë°•ìŠ¤ ìœ„ì¹˜ ë³´ì • ë¡œì§ (í•µì‹¬ ìˆ˜ì •) â–¼â–¼â–¼â–¼â–¼
      // ==========================================
      if (data.detections || needsRecalculation) {
        // needsRecalculation í”Œë˜ê·¸ê°€ ì„¤ì •ëœ ê²½ìš° ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì¡°ì •
        if (needsRecalculation) {
          overlay.width = overlay.clientWidth;
          overlay.height = overlay.clientHeight;
          needsRecalculation = false;
        }
        
        // 1. ìº”ë²„ìŠ¤ê°€ í™”ë©´ì— í‘œì‹œë˜ëŠ” ì‹¤ì œ í¬ê¸° (e.g., 800px, 450px)
        const cW = overlay.clientWidth;
        const cH = overlay.clientHeight;

        // 2. ë¹„ë””ì˜¤ ì›ë³¸ì˜ í•´ìƒë„ (e.g., 1280px, 720px)
        const vW = video.videoWidth;
        const vH = video.videoHeight;
        
        // 3. ìº”ë²„ìŠ¤ í•´ìƒë„ë¥¼ í™”ë©´ í‘œì‹œ í¬ê¸°ì™€ ì¼ì¹˜ì‹œí‚´ (ì™œê³¡ ë°©ì§€)
        if (overlay.width !== cW || overlay.height !== cH) {
          overlay.width = cW;
          overlay.height = cH;
        }

        // 4. 'object-fit: cover' ìŠ¤ì¼€ì¼ë§ ë° ì˜¤í”„ì…‹ ê³„ì‚°
        const vAR = vW / vH; // ë¹„ë””ì˜¤ ì›ë³¸ ë¹„ìœ¨
        const cAR = cW / cH; // ìº”ë²„ìŠ¤(ì»¨í…Œì´ë„ˆ) í‘œì‹œ ë¹„ìœ¨
        
        let scale, dx, dy;

        if (vAR > cAR) {
            // ë¹„ë””ì˜¤ê°€ ì»¨í…Œì´ë„ˆë³´ë‹¤ ë„“ì€ ê²½ìš° (ì¢Œìš°ê°€ ì˜ë¦¼)
            scale = cH / vH; // ë†’ì´ì— ë§ì¶° ìŠ¤ì¼€ì¼ë§
            dx = (cW - vW * scale) / 2; // Xì¶• ì˜¤í”„ì…‹ (ì¤‘ì•™ ì •ë ¬)
            dy = 0;
        } else {
            // ë¹„ë””ì˜¤ê°€ ì»¨í…Œì´ë„ˆë³´ë‹¤ ê¸¸ê±°ë‚˜ ê°™ì€ ê²½ìš° (ìƒí•˜ê°€ ì˜ë¦¼)
            scale = cW / vW; // ë„ˆë¹„ì— ë§ì¶° ìŠ¤ì¼€ì¼ë§
            dx = 0;
            dy = (cH - vH * scale) / 2; // Yì¶• ì˜¤í”„ì…‹ (ì¤‘ì•™ ì •ë ¬)
        }

        // 5. ì´ì „ ê·¸ë¦¼ ì§€ìš°ê¸°
        ctx.clearRect(0, 0, cW, cH);

        // 6. ìŠ¤ì¼€ì¼/ì˜¤í”„ì…‹ì´ ì ìš©ëœ ì¢Œí‘œë¡œ ë°•ìŠ¤ ê·¸ë¦¬ê¸° (ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ)
        if (data.detections) {
          data.detections.forEach(det => {
            // ì„œë²„ì—ì„œ ë°›ì€ ì›ë³¸ ë¹„ë””ì˜¤ ê¸°ì¤€ ì¢Œí‘œ
            const [x1_video, y1_video, x2_video, y2_video] = det.box;
            
            // í™”ë©´(ìº”ë²„ìŠ¤) ê¸°ì¤€ ì¢Œí‘œë¡œ ë³€í™˜
            const x1_canvas = x1_video * scale + dx;
            const y1_canvas = y1_video * scale + dy;
            const x2_canvas = x2_video * scale + dx;
            const y2_canvas = y2_video * scale + dy;
            
            // (ì„ íƒì‚¬í•­) í™”ë©´ ë°–ìœ¼ë¡œ ì™„ì „íˆ ë²—ì–´ë‚œ ë°•ìŠ¤ëŠ” ê·¸ë¦¬ì§€ ì•ŠìŒ
            if (x2_canvas < 0 || x1_canvas > cW || y2_canvas < 0 || y1_canvas > cH) {
                return;
            }

            const label = det.label;
            const color = det.color || '#00A9FF'; // ì„œë²„ì—ì„œ ë°›ì€ ìƒ‰ìƒ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒë€ìƒ‰

            // 1. í…ìŠ¤íŠ¸ì™€ ë°°ê²½ ë¨¼ì € ê·¸ë¦¬ê¸°
            ctx.font = 'bold 18px "Nanum Gothic", sans-serif';
            const textWidth = ctx.measureText(label).width;
            const textX = x1_canvas + 5;
            const textY = y1_canvas > 20 ? y1_canvas - 5 : y1_canvas + 18;

            // í…ìŠ¤íŠ¸ ë°°ê²½ ì„¤ì • (í´ë˜ìŠ¤ ê³ ìœ  ìƒ‰ìƒ)
            ctx.fillStyle = color;
            ctx.fillRect(x1_canvas, textY - 20, textWidth + 10, 24);

            // í…ìŠ¤íŠ¸ ì„¤ì • (í°ìƒ‰)
            ctx.fillStyle = 'white';
            ctx.fillText(label, textX, textY);

            // 2. ë°”ìš´ë”© ë°•ìŠ¤ ì™¸ê³½ì„  ë‚˜ì¤‘ì— ê·¸ë¦¬ê¸°
            ctx.strokeStyle = color; // ì™¸ê³½ì„  ìƒ‰ìƒì€ í´ë˜ìŠ¤ ê³ ìœ  ìƒ‰ìƒ
            ctx.lineWidth = 3;
            ctx.strokeRect(x1_canvas, y1_canvas, x2_canvas - x1_canvas, y2_canvas - y1_canvas);
          });
        }

        // ==========================================
        // â–²â–²â–²â–²â–² ë°•ìŠ¤ ìœ„ì¹˜ ë³´ì • ë¡œì§ (ìˆ˜ì • ì™„ë£Œ) â–²â–²â–²â–²â–²
        // ==========================================
        
        // ê¸°ì¡´ ì¬ë£Œ ëª©ë¡ ì—…ë°ì´íŠ¸ ë¡œì§ (ë™ì¼)
        if (data.detections) {
          const detectedNames = data.detections.map(d => d.name);
          updateDetectedIngredients(detectedNames);
          if (isFullscreenMode) {
              updateFloatingIngredients(detectedNames);
          }
        }
      }
      
      // ìµœì¢… ì¸ì‹ ê²°ê³¼ ì²˜ë¦¬ (ë™ì¼)
      if (data.final_detections && data.final_detections.length > 0) {
        showIngredientSection(data.final_detections);
      }
    };
    
    websocket.onclose = function(event) {
      console.log('ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œ');
      ctx.clearRect(0, 0, overlay.width, overlay.height); // ì—°ê²° ì¢…ë£Œ ì‹œ ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
      stopCamera();
    };
    
    websocket.onerror = function(error) {
      console.error('ì›¹ì†Œì¼“ ì˜¤ë¥˜:', error);
      alert('ì‹¤ì‹œê°„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    };
  }

  // ==========================================
  // ë””ë°”ì´ìŠ¤ ë°©í–¥(ê°€ë¡œ/ì„¸ë¡œ) í´ë˜ìŠ¤ í† ê¸€ (ì „ì²´í™”ë©´ ëª¨ë“œ ì§€ì› ê°•í™”)
  // ==========================================
  const rootEl = document.documentElement;
  function updateOrientationClass() {
    const isLandscape = window.matchMedia('(orientation: landscape)').matches;
    if (isLandscape) {
      rootEl.classList.add('landscape-mode');
    } else {
      rootEl.classList.remove('landscape-mode');
    }
    
    // ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œë„ ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì¡°ì •
    if (isFullscreenMode && overlay && video) {
      setTimeout(() => {
        overlay.width = overlay.clientWidth;
        overlay.height = overlay.clientHeight;
        // ê°€ë¡œëª¨ë“œ ì „í™˜ ì‹œ ë¹„ë””ì˜¤ í¬ê¸°ë„ ì¬ì¡°ì •
        if (video.videoWidth && video.videoHeight) {
          // ë°•ìŠ¤ ìœ„ì¹˜ ë³´ì • ë¡œì§ ì¬ì‹¤í–‰ì„ ìœ„í•œ í”Œë˜ê·¸
          needsRecalculation = true;
        }
        
        // ê°€ë¡œëª¨ë“œ ì „ì²´í™”ë©´ì—ì„œ í”Œë¡œíŒ… ìœˆë„ìš° ìœ„ì¹˜ ì¡°ì •
        if (floatingIngredients && isMobileView()) {
          adjustFloatingWindowForLandscape();
        }
      }, 100);
    }
  }

  // ê°€ë¡œëª¨ë“œ ì „ì²´í™”ë©´ì—ì„œ í”Œë¡œíŒ… ìœˆë„ìš° ìœ„ì¹˜ ì¡°ì • í•¨ìˆ˜
  function adjustFloatingWindowForLandscape() {
    if (!floatingIngredients || !isMobileView() || !isFullscreenMode) return;
    
    const isLandscape = window.matchMedia('(orientation: landscape)').matches;
    if (isLandscape) {
      // ê°€ë¡œëª¨ë“œì¼ ë•Œ í”Œë¡œíŒ… ìœˆë„ìš° í¬ê¸°ì™€ ìœ„ì¹˜ ì¡°ì •
      floatingIngredients.style.maxWidth = '280px';
      floatingIngredients.style.maxHeight = '80vh';
      floatingIngredients.style.top = '10px';
      floatingIngredients.style.right = '10px';
      floatingIngredients.style.fontSize = '12px';
      floatingIngredients.style.padding = '12px';
    }
  }

  document.addEventListener('DOMContentLoaded', updateOrientationClass);
  // ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œë„ ë°©í–¥ ì „í™˜ ê°ì§€ ê°•í™”
  window.addEventListener('orientationchange', () => setTimeout(updateOrientationClass, 300));
  window.addEventListener('resize', () => setTimeout(updateOrientationClass, 100));
  document.addEventListener('fullscreenchange', updateOrientationClass);

  // ==========================================
  // ì¹´ë©”ë¼ ì‹œì‘/ì •ì§€/í”„ë ˆì„ ì „ì†¡ í•¨ìˆ˜ (ë™ì¼)
  // ==========================================
  
  // ì¹´ë©”ë¼ ì‹œì‘
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: currentFacingMode,
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      });
      video.srcObject = stream;
      isStreaming = true;
      sendFrames();
    } catch (err) {
      console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', err);
      alert('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
    }
  }

  // ì¹´ë©”ë¼ ì •ì§€
  function stopCamera() {
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
    isStreaming = false;
  }

  // í”„ë ˆì„ ì „ì†¡ (10fps)
  function sendFrames() {
    if (!isStreaming || !websocket || websocket.readyState !== WebSocket.OPEN) {
      return;
    }

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const canvas = document.createElement('canvas');
      // ì „ì†¡í•  í”„ë ˆì„ í•´ìƒë„ë¥¼ ë¹„ë””ì˜¤ ì›ë³¸ìœ¼ë¡œ ì„¤ì •
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = canvas.toDataURL('image/jpeg', 0.7); // í’ˆì§ˆ ì•½ê°„ ë‚®ì¶° ì „ì†¡ëŸ‰ ê°ì†Œ
      
      websocket.send(JSON.stringify({
        frame: imageData
      }));
    }

    setTimeout(sendFrames, 100);
  }

  // ==========================================
  // ì¬ë£Œ ì²˜ë¦¬ ë° ë ˆì‹œí”¼ ì¶”ì²œ í•¨ìˆ˜ (ë™ì¼)
  // ==========================================

  // ì¸ì‹ëœ ì¬ë£Œ ì—…ë°ì´íŠ¸ (ë¬¸ìì—´ ë°°ì—´ì„ ë°›ìŒ)
  function updateDetectedIngredients(detections) {
    detections.forEach(ingredient => {
      if (ingredient && ingredient !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        detectedIngredients.add(ingredient);
      }
    });
  }

  // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ
  function showIngredientSection(finalDetections) {
    finalDetections.forEach(ingredient => {
      if (ingredient && ingredient !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        detectedIngredients.add(ingredient);
      }
    });

    if (detectedIngredients.size > 0) {
      renderIngredientChips(Array.from(detectedIngredients));
      ingredientButtons.style.display = 'block';
      ingredientButtons.scrollIntoView({ behavior: 'smooth' });
      if (mobileActionBar && isMobileView()) {
        mobileActionBar.style.display = 'none';
      }
    }
  }

  // ì¬ë£Œ ì¹© ë Œë”ë§
  function renderIngredientChips(ingredients) {
    recognizedList.innerHTML = '';
    ingredients.forEach(ingredient => {
      const label = document.createElement('label');
      label.className = 'chip';
      label.innerHTML = `
        <input type="checkbox" class="chip-radio" name="q" value="${escapeHtml(ingredient)}" checked>
        ${escapeHtml(ingredient)}
      `;
      recognizedList.appendChild(label);
    });
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function getRecipeRecommendations(selectedIngredients, page = 1) {
    try {
      const query = selectedIngredients.map(q => `q=${encodeURIComponent(q)}`).join('&');
      const response = await fetch(`/api/recipes/?${query}&sort=${currentSort}&page=${page}&limit=6`);

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      return data; // data.recipes, data.total_pages, data.total_count ì‚¬ìš©
    } catch (error) {
      console.error('ë ˆì‹œí”¼ ì¶”ì²œ ì˜¤ë¥˜:', error);
      throw error;
    }
  }


  function renderPagination(data, selectedIngredients) {
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";

  const totalPages = data.total_pages;
  const pageRange = data.page_range || [];
  const currentPage = data.current_page || 1;

  if (!totalPages || totalPages <= 1) {
    pagination.style.display = "none";
    return;
  }
  pagination.style.display = "block";

  // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
  if (currentPage > 1) {
    const prevBtn = document.createElement("a");
    prevBtn.textContent = "<";
    prevBtn.className = "page-btn";
    prevBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      const newData = await getRecipeRecommendations(selectedIngredients, currentPage - 1);
      renderRecipes(newData.recipes);
      renderPagination(newData, selectedIngredients);
      recipeHeaderText.textContent =
        `${selectedIngredients.join(', ')}ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ (${newData.total_count}ê°œ)`;
    });
    pagination.appendChild(prevBtn);
  } else {
    const prevSpan = document.createElement("span");
    prevSpan.textContent = "<";
    prevSpan.className = "page-btn disabled";
    pagination.appendChild(prevSpan);
  }

  // ëª¨ë°”ì¼ ê°ì§€
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  
  // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤ (ëª¨ë°”ì¼: 5ê°œ, ë°ìŠ¤í¬í†±: 10ê°œ)
  const maxPages = isMobile ? 5 : 10;
  const startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
  const endPage = Math.min(totalPages, startPage + maxPages - 1);
  
  // ëª¨ë°”ì¼ì—ì„œëŠ” í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ìœ¼ë¡œ 5ê°œë§Œ í‘œì‹œ
  const displayPages = isMobile ? 
    Array.from({length: Math.min(maxPages, totalPages)}, (_, i) => startPage + i).filter(p => p <= totalPages) :
    pageRange;

  for (let num of displayPages) {
    if (num === currentPage) {
      const activeSpan = document.createElement("span");
      activeSpan.textContent = num;
      activeSpan.className = "page-btn active";
      pagination.appendChild(activeSpan);
    } else {
      const btn = document.createElement("a");
      btn.textContent = num;
      btn.className = "page-btn";
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        const newData = await getRecipeRecommendations(selectedIngredients, num);
        renderRecipes(newData.recipes);
        renderPagination(newData, selectedIngredients);
        recipeHeaderText.textContent =
          `${selectedIngredients.join(', ')}ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ (${newData.total_count}ê°œ)`;
      });
      pagination.appendChild(btn);
    }
  }

  // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
  if (currentPage < totalPages) {
    const nextBtn = document.createElement("a");
    nextBtn.textContent = ">";
    nextBtn.className = "page-btn";
    nextBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      const newData = await getRecipeRecommendations(selectedIngredients, currentPage + 1);
      renderRecipes(newData.recipes);
      renderPagination(newData, selectedIngredients);
      recipeHeaderText.textContent =
        `${selectedIngredients.join(', ')}ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ (${newData.total_count}ê°œ)`;
    });
    pagination.appendChild(nextBtn);
  } else {
    const nextSpan = document.createElement("span");
    nextSpan.textContent = ">";
    nextSpan.className = "page-btn disabled";
    pagination.appendChild(nextSpan);
  }
}

  // ê³µí†µ: í˜„ì¬ ì²´í¬ëœ ì¬ë£Œ
  function getSelectedIngredients() {
    return Array.from(document.querySelectorAll('#recognized-list input:checked'))
      .map(el => el.value)
      .filter(Boolean); 
  }   

  // ë ˆì‹œí”¼ ê²°ê³¼ ë Œë”ë§
  function renderRecipes(recipes) {
    recipeList.innerHTML = '';
    
    if (recipes.length === 0) {
      recipeList.innerHTML = '<div class="no-result"><p>ì¸ì‹ëœ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      return;
    }

    recipes.forEach(recipe => {
      const recipeCard = document.createElement('div');
      recipeCard.className = 'recipe-card';
      recipeCard.innerHTML = `
        <img src="${escapeHtml(recipe.image)}" alt="${escapeHtml(recipe.title)}">
        <h5>${escapeHtml(recipe.title)}</h5>
        <h6 style="text-align: center;">ì¬ë£Œ</h6>
        <ul style="list-style-type: none; padding-left: 0;">
          ${recipe.ingredients.map(ing => `<li>${escapeHtml(ing)}</li>`).join('')}
        </ul>
        <a href="javascript:void(0)" 
          class="btn-category-done show-extra-btn" 
          data-recipe-id="${recipe.id}"
          data-ingredients='${JSON.stringify(recipe.ingredients)}'>
          ìš”ë¦¬í•˜ëŸ¬ ê°€ê¸°
        </a>
      `;


      recipeList.appendChild(recipeCard);
    });
  }

  // ====== âœ… ì¶”ê°€ì¬ë£Œ ì„ íƒ ì„¹ì…˜ ê¸°ëŠ¥ ======
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("show-extra-btn")) {
    const btn = e.target;
    currentRecipeId = btn.dataset.recipeId;

    // ë²„íŠ¼ datasetì—ì„œ ì¬ë£Œ ë°›ì•„ì˜¤ê¸°
    let ingredients = [];
    try {
      ingredients = JSON.parse(btn.dataset.ingredients || "[]");
    } catch (err) {
      console.error("ì¬ë£Œ JSON íŒŒì‹± ì‹¤íŒ¨:", err, btn.dataset.ingredients);
    }

    // âœ… recipe-section ê·¸ëŒ€ë¡œ ë‘ê³ , extra-sectionë§Œ í‘œì‹œ
    const extraSection = document.getElementById("extra-section");
    const extraIngredientsBox = document.getElementById("extra-ingredients");
    extraSection.style.display = "block";
    extraSection.scrollIntoView({ behavior: "smooth" });

    // ì¹© ìƒì„±
    extraIngredientsBox.innerHTML = "";
    if (!ingredients || ingredients.length === 0) {
      extraIngredientsBox.innerHTML = "<p>ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    } else {
      ingredients.forEach(ing => {
        const name = ing.split(" ")[0];
        extraIngredientsBox.innerHTML += `
          <label class="chip">
            <input type="checkbox" class="chip-radio" name="ingredient" value="${name}">
            <span>${name}</span>
          </label>
        `;
      });
    }
  }
});



    // ì¶”ê°€ì¬ë£Œ ì—†ìŒ â†’ ìƒì„¸ë³´ê¸°
    const skipBtn = document.getElementById("skip-extra-btn");
    if (skipBtn) {
      skipBtn.addEventListener("click", () => {
        if (currentRecipeId) {
          window.location.href = `/recipes/${currentRecipeId}/`;
        } else {
          alert("ë¨¼ì € ìš”ë¦¬í•  ë ˆì‹œí”¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
        }
      });
    }

    // ìƒì„¸ë³´ê¸°ë¡œ ì´ë™
    $("#go-detail-btn")?.addEventListener("click", () => {
      if (currentRecipeId) window.location.href = `/recipes/${currentRecipeId}/`;
      else alert("ë¨¼ì € ìš”ë¦¬í•  ë ˆì‹œí”¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
    });

    // ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™
    $("#go-cart-btn")?.addEventListener("click", () => {
      if (currentRecipeId) {
        const selected = [...document.querySelectorAll("input[name=ingredient]:checked")].map(chk => chk.value);
        const query = selected.length > 0 ? `?extra=${selected.join(",")}` : "";
        window.location.href = `/cart/${currentRecipeId}/${query}`;
      } else {
        alert("ë¨¼ì € ìš”ë¦¬í•  ë ˆì‹œí”¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
      }
    });

  // ì¹´ë©”ë¼ ì „í™˜ í•¨ìˆ˜
  async function switchCamera() {
    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    switchCameraBtn.textContent = currentFacingMode === 'environment' ? 'ğŸ“· ì „ë©´/í›„ë©´' : 'ğŸ“· í›„ë©´/ì „ë©´';
    
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
    }
    
    await startCamera();
  }

  // ì¹´ë©”ë¼ ì¢…ë£Œ ë° ê²°ê³¼ í‘œì‹œ
  function stopCameraAndShowResults() {
    console.log('ê°ì§€ ì™„ë£Œ ë²„íŠ¼ í´ë¦­');
    
    stopCamera();
    if (websocket) {
      websocket.close();
    }
    
    if (detectedIngredients.size > 0) {
      renderIngredientChips(Array.from(detectedIngredients));
      ingredientButtons.style.display = 'block';
      ingredientButtons.scrollIntoView({ behavior: 'smooth' });
      if (mobileActionBar && isMobileView()) {
        mobileActionBar.style.display = 'none';
      }
    } else {
      alert('ì¸ì‹ëœ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      returnToPromo();
    }
  }
  
    // âœ… ì„ íƒ ì™„ë£Œ í´ë¦­
  toRecipeBtn.addEventListener('click', async function() {
    const selectedIngredients = getSelectedIngredients();
    if (selectedIngredients.length === 0) {
      alert('ì¬ë£Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      return;
    }

    try {
      toRecipeBtn.textContent = 'ë ˆì‹œí”¼ ì°¾ëŠ” ì¤‘...';
      toRecipeBtn.disabled = true;

      currentPage = 1;
      const data = await getRecipeRecommendations(selectedIngredients, currentPage);



      console.log("DEBUG data:", data);




      recipeHeaderText.textContent =
        `${selectedIngredients.join(', ')}ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ (${data.total_count}ê°œ)`;

      renderRecipes(data.recipes);
      renderPagination(data, selectedIngredients);

      recipeSection.style.display = 'block';
      recipeSection.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
      console.error('ë ˆì‹œí”¼ ì¶”ì²œ ì˜¤ë¥˜:', error);
      recipeSection.style.display = 'block';
      recipeList.innerHTML = '<div class="no-result"><p>ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>';
    } finally {
      toRecipeBtn.textContent = 'ì„ íƒ ì™„ë£Œ';
      toRecipeBtn.disabled = false;
    }
  });



  // ==========================================
  // UI í”Œë¡œìš° ë° í”Œë¡œíŒ… ìœˆë„ìš° í•¨ìˆ˜ë“¤ (ë™ì¼)
  // ==========================================
  
  function showPromoSection() {
    promoSection.style.display = 'block';
    cameraSection.style.display = 'none';
    permissionModal.style.display = 'none';
    ingredientButtons.style.display = 'none';
    recipeSection.style.display = 'none';
    if (mobileActionBar) mobileActionBar.style.display = 'none';
  }
  
  function showPermissionModal() {
    permissionModal.style.display = 'flex';
    promoSection.style.display = 'none';
    if (mobileActionBar) mobileActionBar.style.display = 'none';
  }
  
  function startCameraDetection() {
    permissionModal.style.display = 'none';
    cameraSection.style.display = 'block';
    setTimeout(() => cameraSection.scrollIntoView({ behavior: 'smooth' }), 300);
    connectWebSocket();
    if (mobileActionBar && isMobileView()) mobileActionBar.style.display = 'block';
  }
  
  function enterFullscreen() {
    const cameraWrapper = cameraSection.querySelector('.camera-wrapper');
    const isMobile = isMobileView();
    try {
      if (isMobile) {
      // ëª¨ë°”ì¼: ë„¤ì´í‹°ë¸Œ ëŒ€ì‹  pseudo-fullscreen ì ìš©
      document.documentElement.classList.add('mobile-fs');
      document.body.classList.add('mobile-fs');
      cameraWrapper.classList.add('mobile-fs');
      isFullscreenMode = true;
      if (floatingIngredients) floatingIngredients.style.display = 'block';
      const ctrls = cameraWrapper.querySelector('.camera-controls');
      if (ctrls) ctrls.style.display = 'none';
      if (mobileActionBar) mobileActionBar.style.display = 'none';
      setTimeout(() => {
        overlay.width = overlay.clientWidth;
        overlay.height = overlay.clientHeight;
        // ê°€ë¡œëª¨ë“œ ì „ì²´í™”ë©´ì—ì„œ í”Œë¡œíŒ… ìœˆë„ìš° ì¡°ì •
        adjustFloatingWindowForLandscape();
      }, 50);
      return;
      }

      // íƒœë¸”ë¦¿/ë°ìŠ¤í¬í†±: í‘œì¤€ ì „ì²´í™”ë©´
      if (cameraWrapper.requestFullscreen) cameraWrapper.requestFullscreen();
      else if (cameraWrapper.webkitRequestFullscreen) cameraWrapper.webkitRequestFullscreen();
      else if (cameraWrapper.mozRequestFullScreen) cameraWrapper.mozRequestFullScreen();
      isFullscreenMode = true;
      if (floatingIngredients) floatingIngredients.style.display = 'block';
      const ctrls = cameraWrapper.querySelector('.camera-controls');
      if (ctrls) ctrls.style.display = 'none';
      if (mobileActionBar) mobileActionBar.style.display = 'none';
      setTimeout(() => {
        overlay.width = overlay.clientWidth;
        overlay.height = overlay.clientHeight;
        // ê°€ë¡œëª¨ë“œ ì „ì²´í™”ë©´ì—ì„œ í”Œë¡œíŒ… ìœˆë„ìš° ì¡°ì •
        adjustFloatingWindowForLandscape();
      }, 50);
    } catch (error) {
      alert('ì „ì²´í™”ë©´ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
    }
  }
  
  function exitFullscreen() {
    const cameraWrapper = cameraSection.querySelector('.camera-wrapper');
    const isMobile = isMobileView();
    isFullscreenMode = false;
    
    if (!isMobile) {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
    } else {
      // ëª¨ë°”ì¼ pseudo-fullscreen í•´ì œ
      document.documentElement.classList.remove('mobile-fs');
      document.body.classList.remove('mobile-fs');
      cameraWrapper.classList.remove('mobile-fs');
    }
    
    floatingIngredients.style.display = 'none';
    cameraSection.querySelector('.camera-controls').style.display = 'flex';
    if (mobileActionBar && isMobileView() && cameraSection.style.display !== 'none') {
      mobileActionBar.style.display = 'block';
    }
    
    // ë°©í–¥ í´ë˜ìŠ¤ ë‹¤ì‹œ í™•ì¸í•˜ì—¬ ìƒíƒœ ë³µì› (ê°€ë¡œëª¨ë“œ ìœ ì§€)
    setTimeout(() => {
      updateOrientationClass();
      overlay.width = overlay.clientWidth;
      overlay.height = overlay.clientHeight;
      // ë°•ìŠ¤ ìœ„ì¹˜ ë³´ì • ë¡œì§ ì¬ì‹¤í–‰
      if (video.videoWidth && video.videoHeight) {
        needsRecalculation = true;
      }
    }, 150);
  }

  // iOS Safari ë„¤ì´í‹°ë¸Œ ë¹„ë””ì˜¤ ì „ì²´í™”ë©´ ì¢…ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  if (video) {
    video.addEventListener('webkitendfullscreen', function() {
      isFullscreenMode = false;
      if (mobileActionBar && isMobileView() && cameraSection && cameraSection.style.display !== 'none') {
        mobileActionBar.style.display = 'block';
      }
    });
  }
  
  // í”Œë¡œíŒ… ìœˆë„ìš° ì¬ë£Œ ì—…ë°ì´íŠ¸ (ë¬¸ìì—´ ë°°ì—´ ë°›ìŒ)
  function updateFloatingIngredients(detections) {
    detections.forEach(ingredient => {
      if (rejectedIngredients.has(ingredient)) return;
      if (!document.getElementById(`floating-${ingredient}`)) {
        addFloatingIngredient(ingredient);
      }
    });
  }
  
  function addFloatingIngredient(ingredient) {
    const ingredientDiv = document.createElement('div');
    ingredientDiv.id = `floating-${ingredient}`;
    ingredientDiv.className = 'floating-ingredient-item';
    ingredientDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 10px; animation: slideInRight 0.3s ease;';
    
    ingredientDiv.innerHTML = `
      <span style="color: white; font-size: 14px; flex: 1;">${ingredient}</span>
      <div style="display: flex; gap: 8px;">
        <button onclick="selectIngredient('${ingredient}')" style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;">âœ… v</button>
        <button onclick="rejectIngredient('${ingredient}')" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;">âŒ x</button>
      </div>
    `;
    if (floatingList) floatingList.appendChild(ingredientDiv);
  }
  
  function selectIngredient(ingredient) {
    confirmedIngredients.add(ingredient);
    detectedIngredients.add(ingredient);
    const el = document.getElementById(`floating-${ingredient}`);
    if (el) {
      el.style.background = 'rgba(76, 175, 80, 0.3)';
      el.style.border = '2px solid #4CAF50';
      el.querySelectorAll('button').forEach(btn => {
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
      });
    }
    updateSelectionCount();
  }
  
  function rejectIngredient(ingredient) {
    rejectedIngredients.add(ingredient);
    confirmedIngredients.delete(ingredient);
    detectedIngredients.delete(ingredient);
    const el = document.getElementById(`floating-${ingredient}`);
    if (el) {
      el.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => el.remove(), 300);
    }
    updateSelectionCount();
  }
  
  function updateSelectionCount() {
    const count = confirmedIngredients.size;
    if (selectedCountSpan) selectedCountSpan.textContent = `${count}ê°œ ì„ íƒ`;
    if (floatingCompleteBtn) {
      floatingCompleteBtn.innerHTML = `ğŸš€ ì„ íƒ ì™„ë£Œ (${count}ê°œ)`;
      floatingCompleteBtn.disabled = count === 0;
      floatingCompleteBtn.style.opacity = count === 0 ? '0.5' : '1';
    }
  }
  
  function completeFloatingSelection() {
    if (confirmedIngredients.size === 0) {
      alert('ì¬ë£Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      return;
    }
    
    exitFullscreen();
    stopCameraAndShowResults(); // ì—¬ê¸°ì—ì„œ ì¹´ë©”ë¼/ì›¹ì†Œì¼“ì´ ë‹«í˜
    
    const selectedArray = Array.from(confirmedIngredients);
    renderIngredientChips(selectedArray);
    if (ingredientButtons) {
      ingredientButtons.style.display = 'block';
      setTimeout(() => ingredientButtons.scrollIntoView({ behavior: 'smooth' }), 500);
    }
    resetFloatingWindow();
  }
  
  function resetFloatingWindow() {
    if (floatingList) floatingList.innerHTML = '';
    confirmedIngredients.clear();
    rejectedIngredients.clear();
    updateSelectionCount();
  }
  
  function returnToPromo() {
    stopCamera();
    if(websocket) websocket.close();
    
    cameraSection.style.display = 'none';
    promoSection.style.display = 'block';
    ingredientButtons.style.display = 'none';
    recipeSection.style.display = 'none';
    
    detectedIngredients.clear();
    confirmedIngredients.clear();
    rejectedIngredients.clear();
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    
    setTimeout(() => promoSection.scrollIntoView({ behavior: 'smooth' }), 300);
    if (mobileActionBar) mobileActionBar.style.display = 'none';
  }
  
  // ==========================================
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ë™ì¼)
  // ==========================================
  if (startDetectionBtn) startDetectionBtn.addEventListener('click', showPermissionModal);
  if (allowCameraBtn) allowCameraBtn.addEventListener('click', startCameraDetection);
  if (cancelCameraBtn) cancelCameraBtn.addEventListener('click', () => {
    permissionModal.style.display = 'none';
    promoSection.style.display = 'block';
  });
  if (fullscreenBtn) fullscreenBtn.addEventListener('click', enterFullscreen);
  if (floatingCompleteBtn) floatingCompleteBtn.addEventListener('click', completeFloatingSelection);
  if (stopCameraBtn) stopCameraBtn.addEventListener('click', stopCameraAndShowResults);
  if (switchCameraBtn) switchCameraBtn.addEventListener('click', switchCamera);
  if (returnHomeBtn) returnHomeBtn.addEventListener('click', () => {
    if (confirm('ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì¸ì‹ëœ ì¬ë£Œê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
      returnToPromo();
    }
  });
  
  document.addEventListener('DOMContentLoaded', showPromoSection);
  window.addEventListener('beforeunload', () => {
    if (websocket) websocket.close();
    stopCamera();
  });
   // âœ… ì •ë ¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
  document.addEventListener("DOMContentLoaded", function() {
    const sortMatchBtn = document.getElementById("sort-match");
    const sortIngredientsBtn = document.getElementById("sort-ingredients");

    async function reloadRecipes() {
      const selectedIngredients = getSelectedIngredients();
      if (selectedIngredients.length === 0) return;

      currentPage = 1;
      const data = await getRecipeRecommendations(selectedIngredients, currentPage);
      renderRecipes(data.recipes);
      renderPagination(data, selectedIngredients);
      recipeHeaderText.textContent =
        `${selectedIngredients.join(', ')}ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ (${data.total_count}ê°œ)`;
    }

    sortMatchBtn.addEventListener("click", function(e) {
      e.preventDefault();
      currentSort = "match";
      sortMatchBtn.classList.add("active");
      sortIngredientsBtn.classList.remove("active");
      reloadRecipes();
    });

    sortIngredientsBtn.addEventListener("click", function(e) {
      e.preventDefault();
      currentSort = "ingredients";
      sortIngredientsBtn.classList.add("active");
      sortMatchBtn.classList.remove("active");
      reloadRecipes();
    });
  });

  // ==============================
  // ëª¨ë°”ì¼ í•˜ë‹¨ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  // ==============================
  const mobileActionBar = document.getElementById('mobile-camera-actions');
  const mobileStopBtn = document.getElementById('mobile-stop');
  const mobileFullscreenBtn = document.getElementById('mobile-fullscreen');
  const mobileReturnHomeBtn = document.getElementById('mobile-return-home');

  function isMobileView() {
    return window.matchMedia('(max-width: 480px)').matches;
  }

  function updateMobileActionBarVisibility() {
    if (!mobileActionBar) return;
    const cameraVisible = cameraSection && cameraSection.style.display !== 'none';
    const selectionVisible = ingredientButtons && ingredientButtons.style.display !== 'none';
    const recipeVisible = recipeSection && recipeSection.style.display !== 'none';
    // ì¸ì‹ëœ ì¬ë£Œ/ë ˆì‹œí”¼ í™”ë©´ì—ì„œëŠ” í•­ìƒ ìˆ¨ê¹€
    if (selectionVisible || recipeVisible) {
      mobileActionBar.style.display = 'none';
      return;
    }
    // ì¹´ë©”ë¼ í™”ë©´ì—ì„œë§Œ ë…¸ì¶œ
    mobileActionBar.style.display = (isMobileView() && cameraVisible) ? 'block' : 'none';
  }

  if (mobileStopBtn) mobileStopBtn.addEventListener('click', stopCameraAndShowResults);
  if (mobileFullscreenBtn) mobileFullscreenBtn.addEventListener('click', enterFullscreen);
  if (mobileReturnHomeBtn) mobileReturnHomeBtn.addEventListener('click', () => {
    if (confirm('ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì¸ì‹ëœ ì¬ë£Œê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
      returnToPromo();
      updateMobileActionBarVisibility();
    }
  });

  window.addEventListener('resize', updateMobileActionBarVisibility);
  document.addEventListener('fullscreenchange', updateMobileActionBarVisibility);
  document.addEventListener('DOMContentLoaded', updateMobileActionBarVisibility);
  window.addEventListener('scroll', updateMobileActionBarVisibility, { passive: true });

  (function () {
    function initMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileNavMenu = document.getElementById('mobileNavMenu');
      
      if (mobileMenuBtn && mobileNavMenu) {
        mobileMenuBtn.addEventListener('click', function() {
          mobileMenuBtn.classList.toggle('active');
          mobileNavMenu.classList.toggle('active');
        });

        document.addEventListener('click', function(e) {
          if (!mobileMenuBtn.contains(e.target) && !mobileNavMenu.contains(e.target)) {
            mobileMenuBtn.classList.remove('active');
            mobileNavMenu.classList.remove('active');
          }
        });
      }
    }
    document.addEventListener('DOMContentLoaded', initMobileMenu);
  })();
</script>

</html>