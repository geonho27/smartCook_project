{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartCook</title>
  <link rel="stylesheet" href="{% static 'css/upload.css' %}" />
  <script src="{% static 'js/upload.js' %}" defer></script>
  <script src="{% static 'js/realtime.js' %}" defer></script>
</head>

<body>
  <main>
    <!-- 상단 네비 -->
    <div class="navbar">
      <div class="nav-left"><div class="logo">SMARTCOOK</div></div>
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-button">Logout</button>
      </form>
    </div>

    <!-- 탐색 방식 버튼 -->
    <div class="btn-group">
      <a href="{% url 'food_upload' %}" class="btn">음식으로 탐색하기</a>
      <a href="{% url 'upload' %}" class="btn">재료로 탐색하기</a>
      <button class="btn active-btn">실시간으로 탐색하기</button>

    </div>
    

    <div class="container2" id="ingredient-section">
      <a href="mainpage.html" class="home-link">← Home</a>
      <div class="form-box">
        <label for="file-upload">카메라 권한을 허용해주세요</label>

        <div class="upload-section">
          <!-- ✅ 브라우저 기본 동작만 사용: for="file-upload" -->
          <div class="dropdown">
          <label class="down-btn" id="realtime-option">
            <div class="down-left">
              <img src="{% static 'images/camera.png' %}" alt="실시간 탐색 아이콘" style="margin-top: 15px; margin-left: 50px; width:44px;height:44px;" />
              <span style="color: white; margin-top: 10px; font-size: 20px;">카메라 권한</span>
            </div>
          </label>
          </div>
        </div>

        <!-- 실시간 재료 탐색 섹션 -->
        <div class="realtime-section" id="realtime-section" style="display: none;">
          <div class="camera-container">
            <!-- 카메라 시작 전 플레이스홀더 -->
            <div class="camera-placeholder" id="camera-placeholder">
              <div class="camera-icon">
                <img src="{% static 'images/image.png' %}" alt="카메라 아이콘">
              </div>
              <h3>실시간 카메라</h3>
              <p>카메라를 활성화하여 재료를 실시간으로 인식하세요</p>
              <button class="camera-btn" id="start-camera">카메라 시작</button>
            </div>
            
            <!-- 카메라 비디오 스트림 -->
            <video id="camera-video" autoplay muted playsinline style="display: none;"></video>
            
            <!-- 카메라 제어 버튼들 -->
            <div class="camera-controls" id="camera-controls" style="display: none;">
              <button class="control-btn capture-btn" id="capture-btn">
                <span class="capture-icon">📸</span>
                <span>촬영</span>
              </button>
              <button class="control-btn switch-btn" id="switch-btn">
                <span class="switch-icon">🔄</span>
                <span>전환</span>
              </button>
              <button class="control-btn stop-btn" id="stop-btn">
                <span class="stop-icon">⏹️</span>
                <span>중지</span>
              </button>
            </div>
            
            <!-- 촬영된 이미지 프리뷰 -->
            <canvas id="camera-canvas" style="display: none;"></canvas>
            <img id="captured-image" style="display: none;" alt="촬영된 이미지">
            
            <!-- 인식 중 표시 -->
            <div class="recognition-overlay" id="recognition-overlay" style="display: none;">
              <div class="recognition-spinner"></div>
              <p>재료를 인식하고 있습니다...</p>
            </div>
          </div>
        </div>

        <!-- 뒤로가기 버튼 -->
        <div class="back-to-options" id="back-to-options" style="display: none;">
          <!-- <button class="back-btn" id="back-to-options-btn">← 다른 방법 선택하기</button> -->
        </div>
      </div>
    </div>

    <!-- 인식된 재료 -->
    <section class="recognized" id="ingredient-buttons" style="display:none;">
      <h4 class="recognized-title">인식된 재료</h4>
      <div class="chip-box" id="recognized-list"></div>
      <div class="confirm-wrapper">
        <button class="confirm-btn" id="toCategoryBtn">선택 완료</button>
      </div>
    </section>

    <!-- 선호도(옵션) -->
    <section class="category" id="category-section" style="display:none;">
      <h4 class="category-title">음식 분야 선택</h4>
      <div class="chip-box">
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 한식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 일식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 양식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 중식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 기타</label>
      </div>
      <div class="range-wrap">
        <label>음식 간 선택</label>
        <input type="range" min="0" max="100" value="50" id="spicyRange" />
        <div class="range-labels">
          <span class="left-label">약하게</span>
          <span class="right-label">강하게</span>
        </div>
      </div>
      <div class="confirm-wrapper">
        <button class="confirm-btn" id="toRecipeBtn">선택 완료</button>
      </div>
    </section>

    <!-- 검색 결과 UI (food_upload.html과 동일하게 적용) -->
    {% if query %}
    <section class="recommend" id="recipe-section" style="display:block;">
      {% if recipes %}
        <p>{{ query }}에 대한 추천 레시피 ({{ recipes|length }}개)</p>
        <div class="recipe-list" id="recipe-list">
          {% for recipe in recipes %}
          <div class="recipe-card" style="{% if forloop.counter > 3 %}display:none;{% endif %}">
            <img src="{{ recipe.image }}" alt="{{ recipe.title }}">
            <h5>{{ recipe.title }}</h5>

            <h6 style="text-align: center;">재료</h6>
            <ul style="list-style-type: none; padding-left: 0;">
              {% for ing in recipe.ingredients %}
              <li>{{ ing.split.0 }}</li>
              {% endfor %}
            </ul>

            {% with "ingredients-"|add:recipe.id as script_id %}
              {{ recipe.ingredients|json_script:script_id }}
            {% endwith %}

            <a href="javascript:void(0)"
               class="btn-category-done show-extra-btn"
               data-recipe-id="{{ recipe.id }}">
               요리하러 가기
            </a>
          </div>
          {% endfor %}
        </div>

        {% if recipes|length > 3 %}
        <div style="text-align:center; margin-top:20px;">
          <button id="loadMoreBtn" class="confirm-btn">더보기</button>
        </div>
        {% endif %}
      {% else %}
        <p>‘{{ query }}’에 해당하는 레시피를 찾을 수 없습니다.</p>
      {% endif %}
    </section>
    {% endif %}

    <!-- ✅ 추가재료 선택 (food_upload.html과 동일하게 적용) -->
    <section class="extra" id="extra-section" style="display:none;">
      <div class="extra-header">
        <h4 class="extra-title">추가 재료 선택</h4>
        <span class="small-text skip-extra" id="skip-extra-btn">
          추가 재료 없음 →
        </span>
      </div>

      <div class="chip-box" id="extra-ingredients"></div>

      <div class="cart-wrapper">
        <button class="cart-btns" id="go-cart-btn" style="margin-right: 10px;">장바구니로 이동</button>
        <button class="cart-btns" id="go-detail-btn">레시피 상세보기</button>
      </div>
    </section>
  </main>

  <!-- 하단 -->
  <div class="feedback-footer">
    © SmartCook. All rights reserved.
  </div>

  <!-- JS -->
  <script src="{% static 'js/upload.js' %}"></script>
</body>
</html>
