{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMARTCOOK - ì‹¤ì‹œê°„ íƒìƒ‰</title>
  
  <!-- ê¸°ë³¸ ì›¹ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="{% static 'css/upload.css' %}" />
  <!-- íƒœë¸”ë¦¿/ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="{% static 'css/resposive_ta_mo.css' %}" />
  <style>
    /* ì›¹ì—ì„œ ë” í° ì¹´ë©”ë¼ ì˜ì—­ */
    @media (min-width: 769px) {
      .upload-form-box {
        max-width: 1200px !important;
      }
      .camera-wrapper {
        padding-top: 45% !important; /* 16:9ë³´ë‹¤ ë” ë„“ê²Œ */
      }
    }
    
    /* ëª¨ë°”ì¼ì—ì„œëŠ” ê¸°ì¡´ í¬ê¸° ìœ ì§€ */
    @media (max-width: 768px) {
      .upload-form-box {
        max-width: 480px !important;
      }
      .camera-wrapper {
        padding-top: 56.25% !important; /* 16:9 ë¹„ìœ¨ ìœ ì§€ */
      }
    }
    
    /* ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .camera-controls button:hover {
      background: rgba(255,255,255,0.3) !important;
    }
  </style>
</head>

<body>
  <main>
    <!-- ë°˜ì‘í˜• ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <div class="main-navbar">
      <!-- ì™¼ìª½ -->
      <div class="main-nav-left">
        <a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a>
      </div>
      
      <!-- ëª¨ë°”ì¼ìš© í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ -->
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    
      <!-- ì˜¤ë¥¸ìª½ -->
      <div class="main-nav-right">
        <form method="POST" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="logout-button">Logout</button>
        </form>
      </div>
    </div>

    <!-- ëª¨ë°”ì¼ìš© ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
    <div class="mobile-nav-menu" id="mobileNavMenu">
      <a href="{% url 'food_upload' %}">Recipe</a>
      <a href="{% url 'upload' %}">Picture</a>
      <a href="{% url 'live_page' %}">Realtime</a>
      <a href="{% url 'mainpage' %}">Home</a>
    </div>

    <!-- íƒìƒ‰ ë°©ì‹ ë²„íŠ¼ -->
    <div class="btn-group">
      <a href="{% url 'food_upload' %}" class="btn">ìŒì‹ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</a>
      <a href="{% url 'upload' %}" class="btn">ì¬ë£Œë¡œ íƒìƒ‰í•˜ê¸°</a>
      <button class="btn active-btn">ì‹¤ì‹œê°„ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</button>
    </div>
    
    <!-- 1ë‹¨ê³„: í™ë³´ ì˜ìƒ ë° ì‹œì‘ ë²„íŠ¼ -->
    <div id="promo-section" class="upload-container">
      <div class="upload-form-box" style="position: relative; width: 100%; max-width: 1200px; margin: 0 auto;">
        <h2 class="upload-title" style="text-align: center;">ì‹¤ì‹œê°„ ì¬ë£Œ ì¸ì‹</h2>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
          ì¹´ë©”ë¼ë¡œ ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ ë¹„ì¶”ë©´ AIê°€ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤
        </p>
        
        <!-- í™ë³´ ì˜ìƒ -->
        <div class="promo-video-wrapper" style="position: relative; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background: #f7f4f0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px;">
          <video autoplay muted loop playsinline
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
            <source src="{% static 'videos/demo.mp4' %}" type="video/mp4">
            ì‹¤ì‹œê°„ ê°ì§€ ë°ëª¨ ì˜ìƒ
          </video>
          
          <!-- ì˜ìƒ ì˜¤ë²„ë ˆì´ í…ìŠ¤íŠ¸ -->
          <div style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 20px; font-size: 14px;">
            ğŸ“¹ ì‹¤ì‹œê°„ ì¬ë£Œ ì¸ì‹ ë°ëª¨
          </div>
        </div>
        
        <!-- ì‹œì‘ ë²„íŠ¼ -->
        <div style="text-align: center;">
          <button id="start-detection-btn" class="start-btn" 
                  style="background: #76b5c5; color: white; border: none; padding: 18px 40px; border-radius: 25px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(118, 181, 197, 0.4); transition: all 0.3s ease;">
            ğŸš€ ì‹¤ì‹œê°„ íƒìƒ‰ ì‹œì‘í•˜ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- 2ë‹¨ê³„: ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ -->
    <div id="permission-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
      <div class="permission-box" style="background: white; padding: 40px 30px; border-radius: 20px; text-align: center; max-width: 400px; margin: 0 20px;">
        <h3 style="color: #76b5c5; margin-bottom: 20px; font-size: 24px;">ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”</h3>
        <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
          ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¸ì‹í•˜ê¸° ìœ„í•´<br>
          ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button id="allow-camera-btn" 
                  style="background: #76b5c5; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; flex: 1; max-width: 120px;">
            í—ˆìš© (Allow)
          </button>
          <button id="cancel-camera-btn" 
                  style="background: #ccc; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; flex: 1; max-width: 120px;">
            ì·¨ì†Œ (Cancel)
          </button>
        </div>
      </div>
    </div>

    <!-- 3ë‹¨ê³„: ì „ì²´í™”ë©´ ì¹´ë©”ë¼ (ê¸°ì¡´ ì½”ë“œ í™œìš©) -->
    <div id="camera-section" class="upload-container" style="display: none;">
      <div class="upload-form-box" style="position: relative; width: 100%; max-width: 1200px; margin: 0 auto;">
        <h2 class="upload-title" style="text-align: center;">ì‹¤ì‹œê°„ ì¬ë£Œ ê°ì§€ ì¤‘...</h2>
        
        <div class="camera-wrapper" style="position: relative; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background: #f7f4f0; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
          <video id="video" autoplay playsinline muted 
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"></video>
          <img id="detected" alt="ì‹¤ì‹œê°„ ê°ì§€ ì´ë¯¸ì§€" 
               style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
          
          <!-- ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
          <div class="camera-controls" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px; display: flex; gap: 10px; z-index: 1000;">
            <button id="switch-camera" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              ğŸ“· ì „ë©´/í›„ë©´
            </button>
            <button id="stop-camera" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              âœ… ê°ì§€ ì™„ë£Œ
            </button>
            <button id="fullscreen-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              ğŸ” ì „ì²´í™”ë©´
            </button>
            <button id="return-home-btn" style="background: rgba(255,100,100,0.3); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: background 0.3s; font-size: 14px;">
              ğŸ  ì²˜ìŒìœ¼ë¡œ
            </button>
          </div>
          
          <!-- í”Œë¡œíŒ… ìœˆë„ìš°: ì‹¤ì‹œê°„ ì¬ë£Œ ì„ íƒ (ì „ì²´í™”ë©´ì—ì„œë§Œ í‘œì‹œ) -->
          <div id="floating-ingredients" style="display: none; position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 15px; max-width: 320px; min-width: 280px; z-index: 10001; backdrop-filter: blur(10px); border: 2px solid rgba(118, 181, 197, 0.5);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
              <h4 style="color: #76b5c5; margin: 0; font-size: 18px;">ğŸ” ì¸ì‹ëœ ì¬ë£Œ</h4>
              <span id="selected-count" style="color: #76b5c5; font-size: 14px; background: rgba(118, 181, 197, 0.2); padding: 4px 8px; border-radius: 10px;">0ê°œ ì„ íƒ</span>
            </div>
            
            <div id="floating-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
              <!-- ì‹¤ì‹œê°„ìœ¼ë¡œ ì¬ë£Œë“¤ì´ ì¶”ê°€ë¨ -->
            </div>
            
            <div style="text-align: center;">
              <button id="floating-complete-btn" style="background: #76b5c5; color: white; border: none; padding: 12px 25px; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(118, 181, 197, 0.4);">
                ğŸš€ ì„ íƒ ì™„ë£Œ (0ê°œ)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ -->
    <section class="recognized" id="ingredient-buttons" style="display:none;">
      <h4 class="recognized-title">ì¸ì‹ëœ ì¬ë£Œ</h4>
      <div class="chip-box" id="recognized-list">
        <!-- ë™ì ìœ¼ë¡œ ì¸ì‹ëœ ì¬ë£Œë“¤ì´ ì¶”ê°€ë¨ -->
      </div>
      <div class="confirm-wrapper">
        <button type="button" id="toRecipeBtn" class="confirm-btn">ì„ íƒ ì™„ë£Œ</button>
      </div>
    </section>

    <!-- ë ˆì‹œí”¼ ì¶”ì²œ ê²°ê³¼ ì„¹ì…˜ -->
    <section class="recommend" id="recipe-section" style="display:none;">
     <div class="result-header">
      <p id="recipe-header-text">ì¸ì‹ëœ ì¬ë£Œì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼</p>
      <div class="sort-options">
        <a href="#" id="sort-match" class="active">ê´€ë ¨ë„ ìˆœ</a>
        <a href="#" id="sort-ingredients">ì¬ë£Œ ì ì€ ìˆœ</a>
        </div>
      </div>

      <div class="recipe-list" id="recipe-list">
    <!-- ë™ì ìœ¼ë¡œ ë ˆì‹œí”¼ë“¤ì´ ì¶”ê°€ë¨ -->
      </div>

    <!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€ -->
    <div class="pagination" id="pagination" style="display:none;"></div>
    </section>

<script>
  const video = document.getElementById('video');
  const detected = document.getElementById('detected');
  const switchCameraBtn = document.getElementById('switch-camera');
  const stopCameraBtn = document.getElementById('stop-camera');
  const ingredientButtons = document.getElementById('ingredient-buttons');
  const recognizedList = document.getElementById('recognized-list');
  const toRecipeBtn = document.getElementById('toRecipeBtn');
  const recipeSection = document.getElementById('recipe-section');
  const recipeList = document.getElementById('recipe-list');
  const recipeHeaderText = document.getElementById('recipe-header-text');
  
  let websocket = null;
  let isStreaming = false;
  let currentFacingMode = 'environment'; // ê¸°ë³¸ê°’: í›„ë©´ ì¹´ë©”ë¼
  let detectedIngredients = new Set(); // ì¸ì‹ëœ ì¬ë£Œë“¤ì„ ì €ì¥
  
  // ìƒˆë¡œìš´ UI ìš”ì†Œë“¤
  const promoSection = document.getElementById('promo-section');
  const permissionModal = document.getElementById('permission-modal');
  const cameraSection = document.getElementById('camera-section');
  const startDetectionBtn = document.getElementById('start-detection-btn');
  const allowCameraBtn = document.getElementById('allow-camera-btn');
  const cancelCameraBtn = document.getElementById('cancel-camera-btn');
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const returnHomeBtn = document.getElementById('return-home-btn');
  
  // í”Œë¡œíŒ… ìœˆë„ìš° ìš”ì†Œë“¤
  const floatingIngredients = document.getElementById('floating-ingredients');
  const floatingList = document.getElementById('floating-list');
  const floatingCompleteBtn = document.getElementById('floating-complete-btn');
  const selectedCountSpan = document.getElementById('selected-count');
  
  // í”Œë¡œíŒ… ìœˆë„ìš° ìƒíƒœ ê´€ë¦¬
  let confirmedIngredients = new Set(); // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¬ë£Œë“¤
  let rejectedIngredients = new Set(); // ì‚¬ìš©ìê°€ ê±°ë¶€í•œ ì¬ë£Œë“¤
  let isFullscreenMode = false; // ì „ì²´í™”ë©´ ëª¨ë“œ ì—¬ë¶€

  // ì›¹ì†Œì¼“ ì—°ê²°
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/detect/`;
    
    websocket = new WebSocket(wsUrl);
    
    websocket.onopen = function(event) {
      console.log('ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ');
      startCamera();
    };
    
    websocket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if (data.image) {
        detected.src = data.image;
      }
      
      // ì¸ì‹ëœ ì¬ë£Œë“¤ ì²˜ë¦¬
      if (data.detections && data.detections.length > 0) {
        updateDetectedIngredients(data.detections);
        
        // ì „ì²´í™”ë©´ ëª¨ë“œì¼ ë•Œë§Œ í”Œë¡œíŒ… ìœˆë„ìš° ì—…ë°ì´íŠ¸
        if (isFullscreenMode) {
          updateFloatingIngredients(data.detections);
        }
      }
      
      // ìµœì¢… ì¸ì‹ ê²°ê³¼ ì²˜ë¦¬
      if (data.final_detections && data.final_detections.length > 0) {
        showIngredientSection(data.final_detections);
      }
    };
    
    websocket.onclose = function(event) {
      console.log('ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œ');
      stopCamera();
      // ì›¹ì†Œì¼“ ì¢…ë£Œ ì‹œì—ëŠ” UIë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€ (ì‚¬ìš©ìê°€ ì¢…ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œê¹Œì§€)
    };
    
    websocket.onerror = function(error) {
      console.error('ì›¹ì†Œì¼“ ì˜¤ë¥˜:', error);
      alert('ì‹¤ì‹œê°„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    };
  }

  // ==========================================
  // ë””ë°”ì´ìŠ¤ ë°©í–¥(ê°€ë¡œ/ì„¸ë¡œ) í´ë˜ìŠ¤ í† ê¸€
  // ==========================================
  const rootEl = document.documentElement;
  function updateOrientationClass() {
    const isLandscape = window.matchMedia('(orientation: landscape)').matches;
    if (isLandscape) {
      rootEl.classList.add('landscape-mode');
    } else {
      rootEl.classList.remove('landscape-mode');
    }
  }

  // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.addEventListener('DOMContentLoaded', updateOrientationClass);
  window.addEventListener('orientationchange', function() {
    // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì „í™˜ ì§í›„ ê°’ ë°˜ì˜ ì§€ì—°
    setTimeout(updateOrientationClass, 200);
  });
  document.addEventListener('fullscreenchange', updateOrientationClass);

  // ì¹´ë©”ë¼ ì‹œì‘
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: currentFacingMode,  // í˜„ì¬ ì„¤ì •ëœ ì¹´ë©”ë¼ ëª¨ë“œ
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      });
      video.srcObject = stream;
      isStreaming = true;
      
      // í”„ë ˆì„ ì „ì†¡ ì‹œì‘
      sendFrames();
    } catch (err) {
      console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', err);
      alert('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
    }
  }

  // ì¹´ë©”ë¼ ì •ì§€
  function stopCamera() {
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
    isStreaming = false;
  }

  // í”„ë ˆì„ ì „ì†¡
  function sendFrames() {
    if (!isStreaming || !websocket || websocket.readyState !== WebSocket.OPEN) {
      return;
    }

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // ìº”ë²„ìŠ¤ë¥¼ base64ë¡œ ë³€í™˜
      const imageData = canvas.toDataURL('image/jpeg', 0.8);
      
      // ì›¹ì†Œì¼“ìœ¼ë¡œ í”„ë ˆì„ ì „ì†¡
      websocket.send(JSON.stringify({
        frame: imageData
      }));
    }

    // 100msë§ˆë‹¤ í”„ë ˆì„ ì „ì†¡ (10fps)
    setTimeout(sendFrames, 100);
  }

  // ì¸ì‹ëœ ì¬ë£Œ ì—…ë°ì´íŠ¸
  function updateDetectedIngredients(detections) {
    detections.forEach(detection => {
      const ingredient = detection.split(' ')[0]; // "ì‚¬ê³¼ 0.85" -> "ì‚¬ê³¼"
      if (ingredient && ingredient !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        detectedIngredients.add(ingredient);
      }
    });
  }

  // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ
  function showIngredientSection(finalDetections) {
    // ìµœì¢… ì¸ì‹ ê²°ê³¼ë¥¼ Setì— ì¶”ê°€
    finalDetections.forEach(ingredient => {
      if (ingredient && ingredient !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        detectedIngredients.add(ingredient);
      }
    });

    // ì¸ì‹ëœ ì¬ë£Œê°€ ìˆìœ¼ë©´ ì„¹ì…˜ í‘œì‹œ
    if (detectedIngredients.size > 0) {
      renderIngredientChips(Array.from(detectedIngredients));
      ingredientButtons.style.display = 'block';
      ingredientButtons.scrollIntoView({ behavior: 'smooth' });
    }
  }

  // ì¬ë£Œ ì¹© ë Œë”ë§
  function renderIngredientChips(ingredients) {
    recognizedList.innerHTML = '';
    ingredients.forEach(ingredient => {
      const label = document.createElement('label');
      label.className = 'chip';
      label.innerHTML = `
        <input type="checkbox" class="chip-radio" name="q" value="${escapeHtml(ingredient)}" checked>
        ${escapeHtml(ingredient)}
      `;
      recognizedList.appendChild(label);
    });
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ë ˆì‹œí”¼ ì¶”ì²œ ìš”ì²­ (JSON API ì‚¬ìš©) - ë” ë§ì€ ë ˆì‹œí”¼ ê°€ì ¸ì˜¤ê¸°
  async function getRecipeRecommendations(selectedIngredients) {
    try {
      const query = selectedIngredients.map(q => `q=${encodeURIComponent(q)}`).join('&');
      // limit íŒŒë¼ë¯¸í„° ì¶”ê°€í•˜ì—¬ ë” ë§ì€ ë ˆì‹œí”¼ ìš”ì²­
      const response = await fetch(`/api/recipes/?${query}&sort=match&limit=20`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.has_recipes) {
        return [];
      }
      
      // JSON ë°ì´í„°ë¥¼ ë ˆì‹œí”¼ ê°ì²´ë¡œ ë³€í™˜
      const recipes = data.recipes.map(recipe => ({
        title: recipe.title || '',
        image: recipe.image || '',
        ingredients: recipe.ingredients || [],
        id: recipe.id || ''
      }));
      
      console.log(`API ì‘ë‹µ:`, data);
      console.log(`APIì—ì„œ ${recipes.length}ê°œ ë ˆì‹œí”¼ ë°›ìŒ (ì „ì²´: ${data.total_count}ê°œ, ì œí•œ: ${data.limit}ê°œ)`);
      return recipes;
    } catch (error) {
      console.error('ë ˆì‹œí”¼ ì¶”ì²œ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ë ˆì‹œí”¼ ê²°ê³¼ ë Œë”ë§
  function renderRecipes(recipes) {
    recipeList.innerHTML = '';
    
    if (recipes.length === 0) {
      recipeList.innerHTML = '<div class="no-result"><p>ì¸ì‹ëœ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      return;
    }

    recipes.forEach(recipe => {
      const recipeCard = document.createElement('div');
      recipeCard.className = 'recipe-card';
      recipeCard.innerHTML = `
        <img src="${escapeHtml(recipe.image)}" alt="${escapeHtml(recipe.title)}" onerror="this.src='/static/images/recipe/muk.png'">
        <h5>${escapeHtml(recipe.title)}</h5>
        <h6 style="text-align: center;">ì¬ë£Œ</h6>
        <ul style="list-style-type: none; padding-left: 0;">
          ${recipe.ingredients.map(ing => `<li>${escapeHtml(ing)}</li>`).join('')}
        </ul>
        <a href="/recipes/${recipe.id}/" class="btn-category-done">
          ìš”ë¦¬í•˜ëŸ¬ ê°€ê¸°
        </a>
      `;
      recipeList.appendChild(recipeCard);
    });
  }


  // ì¹´ë©”ë¼ ì „í™˜ í•¨ìˆ˜
  async function switchCamera() {
    // í˜„ì¬ ì¹´ë©”ë¼ ëª¨ë“œ ë³€ê²½
    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    switchCameraBtn.textContent = currentFacingMode === 'environment' ? 'ğŸ“· ì „ë©´/í›„ë©´' : 'ğŸ“· í›„ë©´/ì „ë©´';
    
    // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì •ì§€
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
    }
    
    // ìƒˆ ì¹´ë©”ë¼ë¡œ ì‹œì‘
    await startCamera();
  }

  // ì¹´ë©”ë¼ ì¢…ë£Œ í•¨ìˆ˜
  function stopCameraStream() {
    console.log('ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ë¨');
    
    stopCamera();
    if (websocket) {
      websocket.close();
    }
    
    // ì¸ì‹ëœ ì¬ë£Œê°€ ìˆìœ¼ë©´ ì„¹ì…˜ í‘œì‹œ
    if (detectedIngredients.size > 0) {
      console.log('ì¸ì‹ëœ ì¬ë£Œ ê°œìˆ˜:', detectedIngredients.size);
      
      // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ
      const ingredientSection = document.getElementById('ingredient-buttons');
      if (ingredientSection) {
        ingredientSection.style.display = 'block';
        console.log('ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ');
        
        // ì¬ë£Œ ì¹© ë Œë”ë§
        renderIngredientChips(Array.from(detectedIngredients));
        
        // ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        ingredientSection.scrollIntoView({ behavior: 'smooth' });
      }
    } else {
      console.log('ì¸ì‹ëœ ì¬ë£Œê°€ ì—†ìŒ');
      alert('ì¸ì‹ëœ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  switchCameraBtn.addEventListener('click', switchCamera);
  stopCameraBtn.addEventListener('click', stopCameraStream);
  
  // ì„ íƒ ì™„ë£Œ ë²„íŠ¼ ì´ë²¤íŠ¸
  toRecipeBtn.addEventListener('click', async function() {
    const selectedIngredients = Array.from(document.querySelectorAll('#recognized-list input:checked'))
      .map(el => el.value)
      .filter(Boolean);

    if (selectedIngredients.length === 0) {
      alert('ì¬ë£Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      return;
    }

    try {
      // ë¡œë”© í‘œì‹œ
      toRecipeBtn.textContent = 'ë ˆì‹œí”¼ ì°¾ëŠ” ì¤‘...';
      toRecipeBtn.disabled = true;

      // ë ˆì‹œí”¼ ì¶”ì²œ ìš”ì²­
      const recipes = await getRecipeRecommendations(selectedIngredients);
      
      // í—¤ë” í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      recipeHeaderText.textContent = `${selectedIngredients.join(', ')}ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ (${recipes.length}ê°œ)`;
      
      // ë ˆì‹œí”¼ ê²°ê³¼ ë Œë”ë§
      renderRecipes(recipes);
      
      // ë ˆì‹œí”¼ ì„¹ì…˜ í‘œì‹œ
      recipeSection.style.display = 'block';
      recipeSection.scrollIntoView({ behavior: 'smooth' });
      
      // ì„±ê³µ ë©”ì‹œì§€
      if (recipes.length > 0) {
        console.log(`${recipes.length}ê°œì˜ ë ˆì‹œí”¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
      } else {
        console.log('í•´ë‹¹ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
      
    } catch (error) {
      console.error('ë ˆì‹œí”¼ ì¶”ì²œ ì˜¤ë¥˜:', error);
      alert('ë ˆì‹œí”¼ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      
      // ì—ëŸ¬ ì‹œì—ë„ ë ˆì‹œí”¼ ì„¹ì…˜ì„ í‘œì‹œí•˜ì—¬ ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°± ì œê³µ
      recipeSection.style.display = 'block';
      recipeList.innerHTML = '<div class="no-result"><p>ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>';
    } finally {
      // ë²„íŠ¼ ìƒíƒœ ë³µì›
      toRecipeBtn.textContent = 'ì„ íƒ ì™„ë£Œ';
      toRecipeBtn.disabled = false;
    }
  });

  // ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼
  switchCameraBtn.addEventListener('mouseenter', function() {
    this.style.background = 'rgba(255,255,255,0.3)';
  });
  switchCameraBtn.addEventListener('mouseleave', function() {
    this.style.background = 'rgba(255,255,255,0.2)';
  });

  stopCameraBtn.addEventListener('mouseenter', function() {
    this.style.background = 'rgba(255,255,255,0.3)';
  });
  stopCameraBtn.addEventListener('mouseleave', function() {
    this.style.background = 'rgba(255,255,255,0.2)';
  });

  // ==========================================
  // ìƒˆë¡œìš´ UI í”Œë¡œìš° í•¨ìˆ˜ë“¤
  // ==========================================
  
  // 1ë‹¨ê³„: í™ë³´ ì˜ìƒ í‘œì‹œ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
  function showPromoSection() {
    if (promoSection) promoSection.style.display = 'block';
    if (cameraSection) cameraSection.style.display = 'none';
    if (permissionModal) permissionModal.style.display = 'none';
    if (ingredientButtons) ingredientButtons.style.display = 'none';
    if (recipeSection) recipeSection.style.display = 'none';
  }
  
  // 2ë‹¨ê³„: ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ í‘œì‹œ
  function showPermissionModal() {
    if (permissionModal) permissionModal.style.display = 'flex';
    if (promoSection) promoSection.style.display = 'none';
  }
  
  // 3ë‹¨ê³„: ì¹´ë©”ë¼ ì‹œì‘ (ê¸°ì¡´ ì›¹ì†Œì¼“ ì—°ê²° í™œìš©)
  function startCameraDetection() {
    if (permissionModal) permissionModal.style.display = 'none';
    if (cameraSection) cameraSection.style.display = 'block';
    
    // ì¹´ë©”ë¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    setTimeout(function() {
      cameraSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
    
    // ê¸°ì¡´ ì›¹ì†Œì¼“ ì—°ê²° í•¨ìˆ˜ í˜¸ì¶œ
    connectWebSocket();
  }
  
  // 4ë‹¨ê³„: ì „ì²´í™”ë©´ ëª¨ë“œ (í”Œë¡œíŒ… ìœˆë„ìš° í¬í•¨)
  function enterFullscreen() {
    const cameraWrapper = cameraSection.querySelector('.camera-wrapper');
    isFullscreenMode = true;
    
    try {
      // ì „ì²´í™”ë©´ API ì‹œë„
      if (cameraWrapper.requestFullscreen) {
        cameraWrapper.requestFullscreen();
      } else if (cameraWrapper.webkitRequestFullscreen) { // Safari
        cameraWrapper.webkitRequestFullscreen();
      } else if (cameraWrapper.mozRequestFullScreen) { // Firefox
        cameraWrapper.mozRequestFullScreen();
      } else {
        // Fallback: ë·°í¬íŠ¸ ì „ì²´ ì‚¬ìš©
        cameraWrapper.style.position = 'fixed';
        cameraWrapper.style.top = '0';
        cameraWrapper.style.left = '0';
        cameraWrapper.style.width = '100vw';
        cameraWrapper.style.height = '100vh';
        cameraWrapper.style.zIndex = '9999';
        cameraWrapper.style.paddingTop = '0';
        
        // ì „ì²´í™”ë©´ ì¢…ë£Œ ë²„íŠ¼ ì¶”ê°€
        const exitBtn = document.createElement('button');
        exitBtn.innerHTML = 'âŒ ì „ì²´í™”ë©´ ì¢…ë£Œ';
        exitBtn.style.cssText = 'position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; z-index: 10001; font-size: 14px;';
        exitBtn.onclick = exitFullscreen;
        cameraWrapper.appendChild(exitBtn);
      }
      
      // í”Œë¡œíŒ… ìœˆë„ìš° í‘œì‹œ
      if (floatingIngredients) {
        floatingIngredients.style.display = 'block';
      }
      
      // ê¸°ì¡´ ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ (ì „ì²´í™”ë©´ì—ì„œëŠ” í”Œë¡œíŒ… ìœˆë„ìš° ì‚¬ìš©)
      const cameraControls = cameraWrapper.querySelector('.camera-controls');
      if (cameraControls) {
        cameraControls.style.display = 'none';
      }
      
    } catch (error) {
      console.error('ì „ì²´í™”ë©´ ì§„ì… ì‹¤íŒ¨:', error);
      alert('ì „ì²´í™”ë©´ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
    }
  }
  
  // ì „ì²´í™”ë©´ ì¢…ë£Œ
  function exitFullscreen() {
    const cameraWrapper = cameraSection.querySelector('.camera-wrapper');
    isFullscreenMode = false;
    
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else {
      // Fallback ì¢…ë£Œ
      cameraWrapper.style.position = 'relative';
      cameraWrapper.style.top = 'auto';
      cameraWrapper.style.left = 'auto';
      cameraWrapper.style.width = '100%';
      cameraWrapper.style.height = 'auto';
      cameraWrapper.style.zIndex = 'auto';
      cameraWrapper.style.paddingTop = '56.25%';
      
      // ì¢…ë£Œ ë²„íŠ¼ ì œê±°
      const exitBtn = cameraWrapper.querySelector('button');
      if (exitBtn && exitBtn.innerHTML.includes('ì „ì²´í™”ë©´ ì¢…ë£Œ')) {
        exitBtn.remove();
      }
    }
    
    // í”Œë¡œíŒ… ìœˆë„ìš° ìˆ¨ê¹€
    if (floatingIngredients) {
      floatingIngredients.style.display = 'none';
    }
    
    // ê¸°ì¡´ ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ ë‹¤ì‹œ í‘œì‹œ
    const cameraControls = cameraWrapper.querySelector('.camera-controls');
    if (cameraControls) {
      cameraControls.style.display = 'flex';
    }
  }
  
  // ==========================================
  // í”Œë¡œíŒ… ìœˆë„ìš° ê´€ë ¨ í•¨ìˆ˜ë“¤
  // ==========================================
  
  // ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€ëœ ì¬ë£Œë¥¼ í”Œë¡œíŒ… ìœˆë„ìš°ì— ì—…ë°ì´íŠ¸
  function updateFloatingIngredients(detections) {
    detections.forEach(detection => {
      const ingredient = detection.split(' ')[0]; // "ì‚¬ê³¼ 0.85" -> "ì‚¬ê³¼"
      
      // ì´ë¯¸ ê±°ë¶€ëœ ì¬ë£ŒëŠ” ë¬´ì‹œ
      if (rejectedIngredients.has(ingredient)) {
        return;
      }
      
      // ì´ë¯¸ ìˆëŠ” ì¬ë£Œì¸ì§€ í™•ì¸
      if (!document.getElementById(`floating-${ingredient}`)) {
        addFloatingIngredient(ingredient);
      }
    });
  }
  
  // í”Œë¡œíŒ… ìœˆë„ìš°ì— ìƒˆë¡œìš´ ì¬ë£Œ ì¶”ê°€
  function addFloatingIngredient(ingredient) {
    const ingredientDiv = document.createElement('div');
    ingredientDiv.id = `floating-${ingredient}`;
    ingredientDiv.className = 'floating-ingredient-item';
    ingredientDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 10px; animation: slideInRight 0.3s ease;';
    
    ingredientDiv.innerHTML = `
      <span style="color: white; font-size: 14px; flex: 1;">${ingredient}</span>
      <div style="display: flex; gap: 8px;">
        <button onclick="selectIngredient('${ingredient}')" 
                style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;">
          âœ… v
        </button>
        <button onclick="rejectIngredient('${ingredient}')" 
                style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; transition: all 0.2s ease;">
          âŒ x
        </button>
      </div>
    `;
    
    if (floatingList) {
      floatingList.appendChild(ingredientDiv);
    }
  }
  
  // ì¬ë£Œ ì„ íƒ (v ë²„íŠ¼)
  function selectIngredient(ingredient) {
    confirmedIngredients.add(ingredient);
    detectedIngredients.add(ingredient); // ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ ë™ê¸°í™”
    
    // UI ì—…ë°ì´íŠ¸
    const ingredientDiv = document.getElementById(`floating-${ingredient}`);
    if (ingredientDiv) {
      ingredientDiv.style.background = 'rgba(76, 175, 80, 0.3)'; // ë…¹ìƒ‰ ë°°ê²½
      ingredientDiv.style.border = '2px solid #4CAF50';
      
      // ë²„íŠ¼ ë¹„í™œì„±í™”
      const buttons = ingredientDiv.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
      });
    }
    
    updateSelectionCount();
    console.log(`ì¬ë£Œ ì„ íƒ: ${ingredient}`);
  }
  
  // ì¬ë£Œ ê±°ë¶€ (x ë²„íŠ¼)
  function rejectIngredient(ingredient) {
    rejectedIngredients.add(ingredient);
    confirmedIngredients.delete(ingredient); // ì„ íƒì—ì„œ ì œê±°
    detectedIngredients.delete(ingredient); // ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œë„ ì œê±°
    
    // UIì—ì„œ ì œê±° (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
    const ingredientDiv = document.getElementById(`floating-${ingredient}`);
    if (ingredientDiv) {
      ingredientDiv.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        ingredientDiv.remove();
      }, 300);
    }
    
    updateSelectionCount();
    console.log(`ì¬ë£Œ ê±°ë¶€: ${ingredient}`);
  }
  
  // ì„ íƒëœ ì¬ë£Œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
  function updateSelectionCount() {
    const count = confirmedIngredients.size;
    
    if (selectedCountSpan) {
      selectedCountSpan.textContent = `${count}ê°œ ì„ íƒ`;
    }
    
    if (floatingCompleteBtn) {
      floatingCompleteBtn.innerHTML = `ğŸš€ ì„ íƒ ì™„ë£Œ (${count}ê°œ)`;
      floatingCompleteBtn.disabled = count === 0;
      floatingCompleteBtn.style.opacity = count === 0 ? '0.5' : '1';
    }
  }
  
  // í”Œë¡œíŒ… ìœˆë„ìš°ì—ì„œ ì„ íƒ ì™„ë£Œ
  function completeFloatingSelection() {
    if (confirmedIngredients.size === 0) {
      alert('ì¬ë£Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      return;
    }
    
    console.log('ì„ íƒëœ ì¬ë£Œë“¤:', Array.from(confirmedIngredients));
    
    // ì „ì²´í™”ë©´ ì¢…ë£Œ
    exitFullscreen();
    
    // ì¹´ë©”ë¼ ì¤‘ì§€
    stopCameraStream();
    
    // ì„ íƒëœ ì¬ë£Œë“¤ì„ ê¸°ì¡´ ì‹œìŠ¤í…œì— ì „ë‹¬
    const selectedArray = Array.from(confirmedIngredients);
    
    // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ì— ì„ íƒëœ ì¬ë£Œë“¤ í‘œì‹œ
    renderIngredientChips(selectedArray);
    if (ingredientButtons) {
      ingredientButtons.style.display = 'block';
      setTimeout(function() {
        ingredientButtons.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 500);
    }
    
    // í”Œë¡œíŒ… ìœˆë„ìš° ì´ˆê¸°í™”
    resetFloatingWindow();
  }
  
  // í”Œë¡œíŒ… ìœˆë„ìš° ì´ˆê¸°í™”
  function resetFloatingWindow() {
    if (floatingList) {
      floatingList.innerHTML = '';
    }
    confirmedIngredients.clear();
    rejectedIngredients.clear();
    updateSelectionCount();
  }
  
  // ì¹´ë©”ë¼ ì¤‘ì§€ ë° ì¸ì‹ëœ ì¬ë£Œ í‘œì‹œ
  function stopCameraAndShowResults() {
    stopCameraStream();
    
    // ì¹´ë©”ë¼ ì„¹ì…˜ì€ ìœ ì§€í•˜ë˜ ì¹´ë©”ë¼ë§Œ ì¤‘ì§€
    // cameraSection.style.display = 'none'; // ì´ ì¤„ ì œê±°
    
    // ì¸ì‹ëœ ì¬ë£Œê°€ ìˆìœ¼ë©´ í‘œì‹œ
    if (detectedIngredients.size > 0) {
      // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ í‘œì‹œ
      renderIngredientChips(Array.from(detectedIngredients));
      if (ingredientButtons) {
        ingredientButtons.style.display = 'block';
        // ì¸ì‹ëœ ì¬ë£Œ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        setTimeout(function() {
          ingredientButtons.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      }
    } else {
      alert('ì¸ì‹ëœ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      // ì¬ë£Œê°€ ì—†ìœ¼ë©´ í™ë³´ ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      if (cameraSection) cameraSection.style.display = 'none';
      if (promoSection) promoSection.style.display = 'block';
      setTimeout(function() {
        promoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  }
  
  // ì™„ì „íˆ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° (ìƒˆë¡œìš´ í•¨ìˆ˜)
  function returnToPromo() {
    stopCameraStream();
    if (cameraSection) cameraSection.style.display = 'none';
    if (promoSection) promoSection.style.display = 'block';
    
    // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¹€
    if (ingredientButtons) ingredientButtons.style.display = 'none';
    if (recipeSection) recipeSection.style.display = 'none';
    
    // ì¸ì‹ëœ ì¬ë£Œ ì´ˆê¸°í™”
    detectedIngredients.clear();
    
    // í™ë³´ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    setTimeout(function() {
      promoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
  }
  
  // ==========================================
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  // ==========================================
  
  // ì‹œì‘ ë²„íŠ¼ í´ë¦­ â†’ ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬
  if (startDetectionBtn) {
    startDetectionBtn.addEventListener('click', function() {
      showPermissionModal();
    });
  }
  
  // í—ˆìš© ë²„íŠ¼ í´ë¦­ â†’ ì¹´ë©”ë¼ ì‹œì‘
  if (allowCameraBtn) {
    allowCameraBtn.addEventListener('click', function() {
      startCameraDetection();
    });
  }
  
  // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ â†’ í™ë³´ ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°
  if (cancelCameraBtn) {
    cancelCameraBtn.addEventListener('click', function() {
      permissionModal.style.display = 'none';
      promoSection.style.display = 'block';
    });
  }
  
  // ì „ì²´í™”ë©´ ë²„íŠ¼ í´ë¦­
  if (fullscreenBtn) {
    fullscreenBtn.addEventListener('click', function() {
      enterFullscreen();
    });
  }
  
  // í”Œë¡œíŒ… ì™„ë£Œ ë²„íŠ¼ í´ë¦­
  if (floatingCompleteBtn) {
    floatingCompleteBtn.addEventListener('click', function() {
      completeFloatingSelection();
    });
  }
  
  // ê°ì§€ ì™„ë£Œ ë²„íŠ¼ (ì¸ì‹ëœ ì¬ë£Œ í‘œì‹œ)
  if (stopCameraBtn) {
    stopCameraBtn.addEventListener('click', function() {
      stopCameraAndShowResults();
    });
  }
  
  // ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
  if (returnHomeBtn) {
    returnHomeBtn.addEventListener('click', function() {
      if (confirm('ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì¸ì‹ëœ ì¬ë£Œê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
        returnToPromo();
      }
    });
  }
  
  // í˜ì´ì§€ ë¡œë“œ ì‹œ í™ë³´ ì„¹ì…˜ í‘œì‹œ (ì›¹ì†Œì¼“ ìë™ ì—°ê²° ì œê±°)
  document.addEventListener('DOMContentLoaded', function() {
    showPromoSection();
  });

  // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
  window.addEventListener('beforeunload', function() {
    if (websocket) {
      websocket.close();
    }
    stopCamera();
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œì—ëŠ” ìë™ìœ¼ë¡œ ëª¨ë“  ê²ƒì´ ì´ˆê¸°í™”ë¨
  });
</script>



    <!-- ì‹¤ì‹œê°„ íƒìƒ‰ì—ì„œëŠ” ì„ í˜¸ë„ ì„ íƒ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ -->

    <!-- ì‹¤ì‹œê°„ íƒìƒ‰ìš© ë ˆì‹œí”¼ ì„¹ì…˜ì€ JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->

    <!-- ì¶”ê°€ì¬ë£Œ ì„ íƒ ì„¹ì…˜ -->
    <section class="extra" id="extra-section" style="display:none;">
      <div class="extra-header">
        <h4 class="extra-title">ì¶”ê°€ ì¬ë£Œ ì„ íƒ</h4>
        <span class="small-text skip-extra" id="skip-extra-btn">
          ì¶”ê°€ ì¬ë£Œ ì—†ìŒ â†’
        </span>
      </div>

      <div class="chip-box" id="extra-ingredients"></div>

      <div class="cart-wrapper">
        <button class="cart-btns" id="go-cart-btn" style="margin-right: 10px;">ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™</button>
        <button class="cart-btns" id="go-detail-btn">ë ˆì‹œí”¼ ìƒì„¸ë³´ê¸°</button>
      </div>
    </section>
  </main>

  <div class="feedback-footer">
    Â© SmartCook. All rights reserved.
  </div>

  <!-- ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´ JavaScript -->
  <script>
  (function () {
    // ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
    function initMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileNavMenu = document.getElementById('mobileNavMenu');
      
      if (mobileMenuBtn && mobileNavMenu) {
        mobileMenuBtn.addEventListener('click', function() {
          // í–„ë²„ê±° ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ í† ê¸€
          mobileMenuBtn.classList.toggle('active');
          // ëª¨ë°”ì¼ ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
          mobileNavMenu.classList.toggle('active');
        });

        // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
        document.addEventListener('click', function(e) {
          if (!mobileMenuBtn.contains(e.target) && !mobileNavMenu.contains(e.target)) {
            mobileMenuBtn.classList.remove('active');
            mobileNavMenu.classList.remove('active');
          }
        });
      }
    }

    // DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', initMobileMenu);
  })();
  </script>
  
  <!-- ì‹¤ì‹œê°„ íƒìƒ‰ìš© JavaScriptëŠ” ì¸ë¼ì¸ìœ¼ë¡œ êµ¬í˜„ë¨ -->
</body>
</html>
