{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartCook</title>
  <link rel="stylesheet" href="{% static 'css/upload.css' %}" />
  <script src="{% static 'js/upload.js' %}" defer></script>
</head>
<body>
  <form id="csrf-form" style="display:none;">{% csrf_token %}</form>

  <main>
    <div class="main-navbar">
      <!-- ì™¼ìª½ -->
      <div class="main-nav-left">
        <a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a>
      </div>
    
      <!-- ì˜¤ë¥¸ìª½ -->
      <div class="main-nav-right">
        <form method="POST" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="logout-button">Logout</button>
        </form>
      </div>
    </div>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="btn-group">
      <a href="{% url 'food_upload' %}" class="btn">ìŒì‹ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</a>
      <button class="btn active-btn">ì¬ë£Œë¡œ íƒìƒ‰í•˜ê¸°</button>
      <a href="{% url 'live_page' %}" class="btn">ì‹¤ì‹œê°„ìœ¼ë¡œ íƒìƒ‰í•˜ê¸°</a>
    </div>

    <!-- ì¬ë£Œ ì—…ë¡œë“œ -->
    <div class="container2" id="ingredient-section">
      <a href="{% url 'mainpage' %}" class="home-link">â† Home</a>
      <div class="form-box">
        <label for="file-upload">ì¬ë£Œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</label>
        <div class="upload-section">
          <div class="dropdown">
            <button class="dropdown-btn" id="dropdownToggle">
              <img src="{% static 'images/file-icon.png' %}" style="width:44px;height:58px;" alt="íŒŒì¼ ì•„ì´ì½˜" />
              <span style="font-size:20px;margin-left:10px;"> íŒŒì¼ ì„ íƒ</span>
            </button>
            <div class="dropdown-menu" id="dropdownMenu">
              <div data-value="device">ğŸ“‚ ê¸°ê¸°ì—ì„œ</div>
              <div data-value="gallery">ğŸ–¼ ê°¤ëŸ¬ë¦¬ì—ì„œ</div>
              <div data-value="dropbox">â˜ dropboxì—ì„œ</div>
              <div data-value="onedrive">ğŸ’  OneDriveì—ì„œ</div>
              <div data-value="gdrive">ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ</div>
            </div>
          </div>
          <input type="file" id="file-upload" accept="image/*" style="display:none;" />
          <div class="image-preview-box">
            <img id="preview-image" style="max-width:100%;display:none;border-radius:10px;" alt="ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°" />
          </div>
        </div>
      </div>
    </div>

    <!-- ì¸ì‹ëœ ì¬ë£Œ -->
    <section class="recognized" id="ingredient-buttons" style="display:none;">
      <h4 class="recognized-title">ì¸ì‹ëœ ì¬ë£Œ</h4>

      <!-- ë³µìˆ˜ ì„ íƒ form -->
      <form method="get" action="{% url 'search_recipes_by_detected' %}">
        <div class="chip-box" id="recognized-list">
          {% if query_list %}
            {% for ing in query_list %}
              <label class="chip">
                <input type="checkbox" name="q" value="{{ ing }}">
                {{ ing }}
              </label>
            {% endfor %}
          {% else %}
            <p>ì•„ì§ ì¸ì‹ëœ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endif %}
        </div>
        <div class="confirm-wrapper">
          <button type="button" id="toRecipeBtn" class="confirm-btn">ì„ íƒ ì™„ë£Œ</button>
        </div>
      </form>
    </section>

    <!-- ê²°ê³¼ ë“¤ì–´ê°ˆ ìë¦¬ -->
    {% if query or query_list %}
    <section class="recommend" id="recipe-section">
      <div class="result-header">
        <p id="recipe-title">
          {% if hasRecipes %}
            "{% if selected_ingredients %}{{ selected_ingredients|join:", " }}{% else %}{{ query }}{% endif %}"ì— ëŒ€í•œ ì¶”ì²œ ë ˆì‹œí”¼ ({{ recipes.paginator.count }}ê°œ)
          {% else %}
            ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          {% endif %}
        </p>

        {% if hasRecipes %}
        <div class="sort-options">
          <a href="?{% for q in selected_ingredients %}q={{ q }}&{% endfor %}sort=match" class="{% if sort == 'match' %}active{% endif %}">ê´€ë ¨ë„ ìˆœ</a> |
          <a href="?{% for q in selected_ingredients %}q={{ q }}&{% endfor %}sort=ingredients" class="{% if sort == 'ingredients' %}active{% endif %}">ì¬ë£Œ ì ì€ ìˆœ</a>
        </div>
        {% endif %}
      </div>

      <div class="recipe-list" id="recipe-list">
        {% if hasRecipes %}
          {% for r in recipes %}
          <div class="recipe-card">
            <img src="{{ r.image }}" alt="{{ r.title }}">
            <h5>{{ r.title }}</h5>
            <h6 style="text-align:center;">ì¬ë£Œ</h6>
            <ul style="list-style-type:none;padding-left:0;">
              {% for i in r.ingredients %}
                <li>{{ i }}</li>
              {% endfor %}
            </ul>
          
            {# âœ… ë ˆì‹œí”¼ì˜ ì¬ë£Œë¥¼ json_scriptë¡œ ë„˜ê²¨ì¤Œ #}
            {% with "ingredients-"|add:r.id as script_id %}
              {{ r.ingredients|json_script:script_id }}
            {% endwith %}
          
            <a href="javascript:void(0)"
               class="btn-category-done show-extra-btn"
               data-recipe-id="{{ r.id }}">
               ìš”ë¦¬í•˜ëŸ¬ ê°€ê¸°
            </a>
          </div>
          {% endfor %}
        {% elif query or query_list %}
          <!-- ê²€ìƒ‰ì€ í–ˆì§€ë§Œ ê²°ê³¼ ì—†ìŒ -->
          <div class="no-result">
            ì¡°ê±´ì— ë§ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        {% endif %}
      </div>

      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      {% if hasRecipes and recipes.has_other_pages %}
        <div class="pagination">
          {% if recipes.has_previous %}
            <a href="?{% for q in query_list %}q={{ q }}&{% endfor %}sort={{ sort }}&page={{ recipes.previous_page_number }}" class="page-btn">&lt;</a>
          {% else %}
            <span class="page-btn disabled">&lt;</span>
          {% endif %}

          {% for num in page_range %}
            {% if recipes.number == num %}
              <span class="page-btn active">{{ num }}</span>
            {% else %}
              <a href="?{% for q in query_list %}q={{ q }}&{% endfor %}sort={{ sort }}&page={{ num }}" class="page-btn">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if recipes.has_next %}
            <a href="?{% for q in query_list %}q={{ q }}&{% endfor %}sort={{ sort }}&page={{ recipes.next_page_number }}" class="page-btn">&gt;</a>
          {% else %}
            <span class="page-btn disabled">&gt;</span>
          {% endif %}
        </div>
      {% endif %}
    </section>
    {% endif %}

    <!-- ì¶”ê°€ì¬ë£Œ -->
    <section class="extra" id="extra-section" style="display:none;">
      <div class="extra-header">
        <h4 class="extra-title">ì¶”ê°€ ì¬ë£Œ ì„ íƒ</h4>
        <span class="small-text skip-extra" id="skip-extra-btn">
          ì¶”ê°€ ì¬ë£Œ ì—†ìŒ â†’
        </span>
      </div>

      <div class="chip-box" id="extra-ingredients"></div>

      <div class="cart-wrapper">
        <button class="cart-btns" id="go-cart-btn" style="margin-right: 10px;">ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™</button>
        <button class="cart-btns" id="go-detail-btn">ë ˆì‹œí”¼ ìƒì„¸ë³´ê¸°</button>
      </div>
    </section>
  </main>

  <div class="feedback-footer">Â© SmartCook. All rights reserved.</div>
</body>
</html>
