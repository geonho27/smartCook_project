{% load static %}
{% load split_filters %}

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마이 페이지</title>
  <link rel="stylesheet" href="{% static 'css/upload.css' %}">
  <link rel="stylesheet" href="{% static 'css/resposive_ta_mo.css' %}">
</head>
<body class="upload">
  <div class="main-navbar">
    <!-- 왼쪽 -->
    <div class="main-nav-left">
      <a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a>
    </div>
  
    <!-- 오른쪽 -->
    <div class="main-nav-right">
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-button">Logout</button>
      </form>
    </div>
  </div>
  

  <div class="menu2-container">
    <div class="menu2-breadcrumb">← <a href="{% url 'mainpage' %}">Home</a></div>

    <!-- 회원정보 -->
    <div class="menu2-info-row">
      <div class="menu2-info-label">이름</div>
      <div class="menu2-info-value">{{ user.username }}</div>
    </div>
    <div class="menu2-info-row">
      <div class="menu2-info-label">아이디</div>
      <div class="menu2-info-value">{{ user.userid }}</div>
    </div>
    <div class="menu2-info-row">
      <div class="menu2-info-label">비밀번호</div>
      <div class="menu2-info-value">
        <span id="pwToggle" class="pw-change-link">변경하기</span>
        <div id="pwForm" class="pw-form">
          <input type="password" id="currentPassword" placeholder="현재 비밀번호">
          <input type="password" id="newPassword" placeholder="새 비밀번호">
          <input type="password" id="confirmPassword" placeholder="새 비밀번호 확인">
          <div class="pw-buttons">
            <button type="button" class="btn-save" onclick="changePassword()">저장</button>
            <button type="button" class="btn-cancel" onclick="document.getElementById('pwForm').style.display='none'">취소</button>
          </div>
        </div>
      </div>
    </div>
    
    
    <div class="menu2-info-row">
      <div class="menu2-info-label">이메일</div>
      <div class="menu2-info-value">{{ user.email }}</div>
    </div>

    <hr class="menu2-divider">

    <!-- 추가 정보 -->
    <div class="menu2-section-title">추가 정보</div>

    <!-- 영양 정보 -->
    <!--<div class="menu2-form-row">
      <label>영양 정보</label>
      <div class="menu2-radio-group">
        <label><input type="radio" class="menu2-input" name="nutri"> 당뇨</label>
        <label><input type="radio" class="menu2-input" name="nutri"> 고혈압</label>
        <label><input type="radio" class="menu2-input" name="nutri"> 저염식</label>
        <label><input type="radio" class="menu2-input" name="nutri"> 다이어트 식단</label>
      </div>
    </div>-->

  <!-- ✅ 목소리 선택 (자동 로드) -->
  <div class="menu2-form-row">
    <label>목소리 선택</label>
    <select id="voiceSelect" class="menu2-input">
      <option value="">로딩 중...</option>
    </select>
    <button onclick="previewVoice()" style="margin-left:8px;">미리듣기</button>
    <button onclick="saveVoice()" class="tts-button" style="margin-left:8px;">저장하기</button>
    <span style="color: #999; margin-left:8px;">선택한 목소리는 저장되어 레시피를 읽을 때 사용됩니다.</span>
  </div>




    <!-- ✅ 비건 여부 -->
    <div class="menu2-form-row">
      <label>비건 여부</label>
      <input type="checkbox" class="menu2-input" name="is_vegan" {% if user.is_vegan %}checked{% endif %}>
      <span style="margin-left:8px; color:#76b5c5;">저는 비건입니다</span>
    </div>

    <!-- ✅ 알레르기 
    <div class="menu2-form-row">
      <label>알레르기</label>
      <input type="text" class="menu2-input" name="allergies" placeholder="예: 땅콩, 갑각류" value="{{ user.allergies }}">
    </div> -->

    <!-- 선호 재료 -->
    <div class="menu2-form-row">
      <label>선호하는 재료</label>
      <input type="text" class="menu2-input" id="prefer-input" placeholder="입력 후 엔터">
    </div>
    <div class="menu2-tag-buttons" id="prefer-tags">
      {% for item in preferred|default:''|split:"," %}
  {% if item %}
    <div class="menu2-tag-button">
      {{ item }}<button class="del-btn">x</button>
    </div>
  {% endif %}
{% endfor %}

    </div>

    <!-- 비선호 재료 -->
    <div class="menu2-form-row">
      <label>비선호하는 재료</label>
      <input type="text" class="menu2-input" id="nonprefer-input" placeholder="입력 후 엔터">
    </div>
    <div class="menu2-tag-buttons" id="nonprefer-tags">
      {% for item in disliked|default:''|split:"," %}
        {% if item %}
        <div class="menu2-tag-button">
          {{ item }}<button class="del-btn">x</button>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</body>
</html>


<script>
  const csrfToken = "{{ csrf_token }}";
  // ✅ 목소리 목록 동적으로 불러오기
  async function populateVoiceList() {
    try {
      const response = await fetch("/tts/list-voices/");
      const data = await response.json();
      const voices = data.voices || [];
      const voiceSelect = document.getElementById("voiceSelect");

      voiceSelect.innerHTML = ""; // 초기화

      voices.forEach(voice => {
        const option = document.createElement("option");
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.gender})`;
        voiceSelect.appendChild(option);
      });

      const savedVoice = "{{ user.voice_name|escapejs }}";
      if (savedVoice) {
        voiceSelect.value = savedVoice;
      }
    } catch (error) {
      console.error("음성 목록 불러오기 실패:", error);
      const voiceSelect = document.getElementById("voiceSelect");
      voiceSelect.innerHTML = `<option value="">목소리 불러오기 실패</option>`;
    }
  }

  // ✅ 선택한 목소리 저장
  function saveVoice() {
    const selected = document.getElementById("voiceSelect").value;
    if (selected) {
      fetch("{% url 'save_voice' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ voice_name: selected })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`목소리 "${selected}"가 저장되었습니다.`);
        } else {
          alert("저장에 실패했습니다.");
        }
      });
    }
  }

  // 서버 저장 함수
  function saveUserData(data) {
    return fetch("{% url 'save_preferences' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify(data)
    }).then(res => res.json()).then(console.log);
  }

  // 비건 체크 저장
  document.addEventListener("DOMContentLoaded", () => {
    const veganCheckbox = document.querySelector("input[name='is_vegan']");
    if (veganCheckbox) {
      veganCheckbox.addEventListener("change", () => {
        saveUserData({ is_vegan: veganCheckbox.checked });
      });
    }
  });

  // 알레르기 저장
  document.addEventListener("DOMContentLoaded", () => {
    const allergyInput = document.querySelector("input[name='allergies']");
    if (allergyInput) {
      allergyInput.addEventListener("blur", () => {
        saveUserData({ allergies: allergyInput.value });
      });
    }
  });

  // 재료 추가 함수 
function addIngredient(inputEl, containerEl, type) {
  const value = inputEl.value.trim();
  if (!value) return;

  // 이미 존재하는지 확인
  const exists = Array.from(containerEl.children).some(child =>
    child.textContent.includes(value)
  );
  if (exists) {
    alert(`이미 "${value}"은(는) 있어요!`);
    inputEl.value = '';
    return;
  }

  // div.menu2-tag-button 생성
  const tag = document.createElement("div");
  tag.className = "menu2-tag-button";

  // 텍스트 부분 (textContent 대신 span)
  const textEl = document.createElement("span");
  textEl.className = "tag-text";
  textEl.textContent = value;

  // 삭제 버튼 추가
  const delBtn = document.createElement("button");
  delBtn.className = "del-btn";
  delBtn.textContent = "✖";

  delBtn.addEventListener("click", () => {
    tag.remove();
    saveUserData({ [`remove_${type}`]: value });
  });

  // div 안에 span(텍스트) + 버튼 넣기
  tag.appendChild(textEl);
  tag.appendChild(delBtn);
  containerEl.appendChild(tag);

  inputEl.value = "";
  saveUserData({ [type]: value });
}

// DOMContentLoaded에서 이벤트 등록
document.addEventListener("DOMContentLoaded", () => {
  const preferInput = document.getElementById("prefer-input");
  const nonpreferInput = document.getElementById("nonprefer-input");
  const preferTags = document.getElementById("prefer-tags");
  const nonpreferTags = document.getElementById("nonprefer-tags");

  // 이미 존재하는 태그들에도 삭제 이벤트 붙이기
  function attachDeleteEvents(containerEl, type) {
    containerEl.querySelectorAll(".menu2-tag-button").forEach(tag => {
      const textEl = tag.querySelector(".tag-text");
      const value = textEl ? textEl.textContent.trim() : "";
      const btn = tag.querySelector(".del-btn");
      if (btn) {
        btn.addEventListener("click", () => {
          tag.remove();
          saveUserData({ [`remove_${type}`]: value });
        });
      }
    });
  }

  attachDeleteEvents(preferTags, "preferred");
  attachDeleteEvents(nonpreferTags, "disliked");

  // 엔터 입력 시 태그 추가
  if (preferInput) {
    preferInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        addIngredient(preferInput, preferTags, "preferred");
      }
    });
  }

  if (nonpreferInput) {
    nonpreferInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        addIngredient(nonpreferInput, nonpreferTags, "disliked");
      }
    });
  }
});


  document.addEventListener("DOMContentLoaded", () => {
    populateVoiceList();  // 페이지 로드되자마자 TTS 목록 불러오기
  });


  function togglePasswordForm() {
    const modal = document.getElementById("pwForm");
    if (modal.style.display === "block") {
      modal.style.display = "none";
    } else {
      modal.style.display = "block";
    }
  }
  
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("pwToggle").addEventListener("click", togglePasswordForm);
  });
  
  function changePassword() {
    const current = document.getElementById("currentPassword").value;
    const newPw = document.getElementById("newPassword").value;
    const confirm = document.getElementById("confirmPassword").value;
  
    if (newPw !== confirm) {
      alert("새 비밀번호가 일치하지 않습니다.");
      return;
    }
  
    fetch("{% url 'change_password' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ current_password: current, new_password: newPw })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("비밀번호가 변경되었습니다.");
        togglePasswordForm(); // 저장 성공 시 닫기
      } else {
        alert(data.error || "변경 실패");
      }
    });
  }
  
  function previewVoice() {
    const voice = document.getElementById("voiceSelect").value; // ✅ 수정
    const sampleText = "안녕하세요, 저는 스마트쿡입니다. 오늘도 맛있는 요리를 시작해 볼까요?";
    const url = `/tts/?text=${encodeURIComponent(sampleText)}&voice=${encodeURIComponent(voice)}`;
    new Audio(url).play();
  }

</script>



