{% load static %}
{% load split_filters %}

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>구독 서비스 페이지</title>
  <link rel="stylesheet" href="{% static 'css/upload.css' %}">
</head>
<body class="upload">
  <div class="main-navbar">
    <!-- 왼쪽 -->
    <div class="main-nav-left">
      <a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a>
    </div>
  
    <!-- 오른쪽 -->
    <div class="main-nav-right">
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-button">Logout</button>
      </form>
    </div>
  </div>
  

  <div class="menu2-container">
    <div class="menu2-breadcrumb">← <a href="{% url 'mainpage' %}">Home</a></div>

    <!-- 회원정보 -->
    <div class="menu2-info-row">
      <div class="menu2-info-label">이름</div>
      <div class="menu2-info-value">{{ user.username }}</div>
    </div>
    <div class="menu2-info-row">
      <div class="menu2-info-label">아이디</div>
      <div class="menu2-info-value">{{ user.userid }}</div>
    </div>
    <div class="menu2-info-row">
      <div class="menu2-info-label">비밀번호</div>
      <div class="menu2-info-value">변경하기</div>
    </div>
    <div class="menu2-info-row">
      <div class="menu2-info-label">이메일</div>
      <div class="menu2-info-value">{{ user.email }}</div>
    </div>

    <hr class="menu2-divider">

    <!-- 추가 정보 -->
    <div class="menu2-section-title">추가 정보</div>

    <!-- 영양 정보 -->
    <!--<div class="menu2-form-row">
      <label>영양 정보</label>
      <div class="menu2-radio-group">
        <label><input type="radio" class="menu2-input" name="nutri"> 당뇨</label>
        <label><input type="radio" class="menu2-input" name="nutri"> 고혈압</label>
        <label><input type="radio" class="menu2-input" name="nutri"> 저염식</label>
        <label><input type="radio" class="menu2-input" name="nutri"> 다이어트 식단</label>
      </div>
    </div>-->

  <!-- ✅ 목소리 선택 (자동 로드) -->
  <div class="menu2-form-row">
    <label>목소리 선택</label>
    <select id="voiceSelect" class="menu2-input">
      <option value="">로딩 중...</option>
    </select>
    <button onclick="saveVoice()" class="tts-button" style="margin-left:8px;">저장하기</button>
    <span style="color: #999; margin-left:8px;">선택한 목소리는 저장되어 레시피를 읽을 때 사용됩니다.</span>
  </div>




    <!-- ✅ 비건 여부 -->
    <div class="menu2-form-row">
      <label>비건 여부</label>
      <input type="checkbox" class="menu2-input" name="is_vegan" {% if user.is_vegan %}checked{% endif %}>
      <span style="margin-left:8px; color:#76b5c5;">저는 비건입니다</span>
    </div>

    <!-- ✅ 알레르기 -->
    <div class="menu2-form-row">
      <label>알레르기</label>
      <input type="text" class="menu2-input" name="allergies" placeholder="예: 땅콩, 갑각류" value="{{ user.allergies }}">
    </div>

    <!-- 선호 재료 -->
    <div class="menu2-form-row">
      <label>선호하는 재료</label>
      <input type="text" class="menu2-input" id="prefer-input" placeholder="입력 후 엔터">
    </div>
    <div class="menu2-tag-buttons" id="prefer-tags">
      {% for item in preferred|default:''|split:"," %}
        {% if item %}
          <span class="tag">{{ item }}<button class="del-btn">X</button></span>
        {% endif %}
      {% endfor %}
    </div>

    <!-- 비선호 재료 -->
    <div class="menu2-form-row">
      <label>비선호하는 재료</label>
      <input type="text" class="menu2-input" id="nonprefer-input" placeholder="입력 후 엔터">
    </div>
    <div class="menu2-tag-buttons" id="nonprefer-tags">
      {% for item in disliked|default:''|split:"," %}
        {% if item %}
          <span class="tag">{{ item }}<button class="del-btn">X</button></span>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</body>
</html>

<script>
  // ✅ 목소리 목록 동적으로 불러오기
  async function populateVoiceList() {
    try {
      const response = await fetch("/tts/list-voices/");
      const data = await response.json();
      const voices = data.voices || [];
      const voiceSelect = document.getElementById("voiceSelect");

      voiceSelect.innerHTML = ""; // 초기화

      voices.forEach(voice => {
        const option = document.createElement("option");
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.gender})`;
        voiceSelect.appendChild(option);
      });

      const savedVoice = "{{ user.voice_name|escapejs }}";
      if (savedVoice) {
        voiceSelect.value = savedVoice;
      }
    } catch (error) {
      console.error("음성 목록 불러오기 실패:", error);
      const voiceSelect = document.getElementById("voiceSelect");
      voiceSelect.innerHTML = `<option value="">목소리 불러오기 실패</option>`;
    }
  }

  // ✅ 선택한 목소리 저장
  function saveVoice() {
    const selected = document.getElementById("voiceSelect").value;
    if (selected) {
      fetch("{% url 'save_voice' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ voice_name: selected })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`목소리 "${selected}"가 저장되었습니다.`);
        } else {
          alert("저장에 실패했습니다.");
        }
      });
    }
  }

  // ✅ 페이지 로드시 자동 실행
  window.addEventListener("DOMContentLoaded", populateVoiceList);
</script>



